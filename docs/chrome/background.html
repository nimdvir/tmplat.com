---
---
{% capture title_suffix %} | Chrome | Documentation | {{ site.title | escape }}{% endcapture %}
<!DOCTYPE html>

<html>
<head>
  <title>background.coffee{{ title_suffix }}</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="/assets/css/docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">


              <a class="source" href="analytics.html">
                analytics.coffee
              </a>


              <a class="source" href="background.html">
                background.coffee
              </a>


              <a class="source" href="content.html">
                content.coffee
              </a>


              <a class="source" href="i18n.html">
                i18n.coffee
              </a>


              <a class="source" href="install.html">
                install.coffee
              </a>


              <a class="source" href="log.html">
                log.coffee
              </a>


              <a class="source" href="options.html">
                options.coffee
              </a>


              <a class="source" href="popup.html">
                popup.coffee
              </a>


              <a class="source" href="store.html">
                store.coffee
              </a>


              <a class="source" href="utils.html">
                utils.coffee
              </a>

          </div>
        </li>
      </ul>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>background.coffee</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p><a href="http://template-extension.org">Template</a><br>(c) 2014 Alasdair Mercer<br>Freely distributable under the MIT license:<br><a href="http://template-extension.org/license">http://template-extension.org/license</a></p>

            </div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="private-constants">Private constants</h2>

            </div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>List of blacklisted extension IDs that should be prevented from sending external messages to
Template.</p>

            </div>

            <div class="content"><div class='highlight'><pre>BLACKLIST         = []</pre></div></div>

        </li>


        <li id="section-4">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Predefined templates to be used by default.</p>

            </div>

            <div class="content"><div class='highlight'><pre>DEFAULT_TEMPLATES = [
  <span class="hljs-attribute">content</span>:  <span class="hljs-string">'{url}'</span>
  <span class="hljs-attribute">enabled</span>:  <span class="hljs-literal">yes</span>
  <span class="hljs-attribute">image</span>:    <span class="hljs-string">'globe'</span>
  <span class="hljs-attribute">index</span>:    <span class="hljs-number">0</span>
  <span class="hljs-attribute">key</span>:      <span class="hljs-string">'PREDEFINED.00001'</span>
  <span class="hljs-attribute">readOnly</span>: <span class="hljs-literal">yes</span>
  <span class="hljs-attribute">shortcut</span>: <span class="hljs-string">'U'</span>
  <span class="hljs-attribute">title</span>:    i18n.get <span class="hljs-string">'default_template_url'</span>
  <span class="hljs-attribute">usage</span>:    <span class="hljs-number">0</span>
,
  <span class="hljs-attribute">content</span>:  <span class="hljs-string">'{#shorten}{url}{/shorten}'</span>
  <span class="hljs-attribute">enabled</span>:  <span class="hljs-literal">yes</span>
  <span class="hljs-attribute">image</span>:    <span class="hljs-string">'tag'</span>
  <span class="hljs-attribute">index</span>:    <span class="hljs-number">1</span>
  <span class="hljs-attribute">key</span>:      <span class="hljs-string">'PREDEFINED.00002'</span>
  <span class="hljs-attribute">readOnly</span>: <span class="hljs-literal">yes</span>
  <span class="hljs-attribute">shortcut</span>: <span class="hljs-string">'S'</span>
  <span class="hljs-attribute">title</span>:    i18n.get <span class="hljs-string">'default_template_short'</span>
  <span class="hljs-attribute">usage</span>:    <span class="hljs-number">0</span>
,
  <span class="hljs-attribute">content</span>:  <span class="hljs-string">"&lt;a href=\"{url}\"{#linksTarget} target=\"_blank\"{/linksTarget}{#linksTitle}
 title=\"{{title}}\"{/linksTitle}&gt;{{title}}&lt;/a&gt;"</span>
  <span class="hljs-attribute">enabled</span>:  <span class="hljs-literal">yes</span>
  <span class="hljs-attribute">image</span>:    <span class="hljs-string">'font'</span>
  <span class="hljs-attribute">index</span>:    <span class="hljs-number">2</span>
  <span class="hljs-attribute">key</span>:      <span class="hljs-string">'PREDEFINED.00003'</span>
  <span class="hljs-attribute">readOnly</span>: <span class="hljs-literal">yes</span>
  <span class="hljs-attribute">shortcut</span>: <span class="hljs-string">'A'</span>
  <span class="hljs-attribute">title</span>:    i18n.get <span class="hljs-string">'default_template_anchor'</span>
  <span class="hljs-attribute">usage</span>:    <span class="hljs-number">0</span>
,
  <span class="hljs-attribute">content</span>:  <span class="hljs-string">'{#encode}{url}{/encode}'</span>
  <span class="hljs-attribute">enabled</span>:  <span class="hljs-literal">yes</span>
  <span class="hljs-attribute">image</span>:    <span class="hljs-string">'lock'</span>
  <span class="hljs-attribute">index</span>:    <span class="hljs-number">3</span>
  <span class="hljs-attribute">key</span>:      <span class="hljs-string">'PREDEFINED.00004'</span>
  <span class="hljs-attribute">readOnly</span>: <span class="hljs-literal">yes</span>
  <span class="hljs-attribute">shortcut</span>: <span class="hljs-string">'E'</span>
  <span class="hljs-attribute">title</span>:    i18n.get <span class="hljs-string">'default_template_encoded'</span>
  <span class="hljs-attribute">usage</span>:    <span class="hljs-number">0</span>
,
  <span class="hljs-attribute">content</span>:  <span class="hljs-string">'[url={url}]{title}[/url]'</span>
  <span class="hljs-attribute">enabled</span>:  <span class="hljs-literal">no</span>
  <span class="hljs-attribute">image</span>:    <span class="hljs-string">'comment'</span>
  <span class="hljs-attribute">index</span>:    <span class="hljs-number">5</span>
  <span class="hljs-attribute">key</span>:      <span class="hljs-string">'PREDEFINED.00005'</span>
  <span class="hljs-attribute">readOnly</span>: <span class="hljs-literal">yes</span>
  <span class="hljs-attribute">shortcut</span>: <span class="hljs-string">'B'</span>
  <span class="hljs-attribute">title</span>:    i18n.get <span class="hljs-string">'default_template_bbcode'</span>
  <span class="hljs-attribute">usage</span>:    <span class="hljs-number">0</span>
,
  <span class="hljs-attribute">content</span>:  <span class="hljs-string">'[{title}]({url}{#linksTitle} "{title}"{/linksTitle})'</span>
  <span class="hljs-attribute">enabled</span>:  <span class="hljs-literal">no</span>
  <span class="hljs-attribute">image</span>:    <span class="hljs-string">'asterisk'</span>
  <span class="hljs-attribute">index</span>:    <span class="hljs-number">4</span>
  <span class="hljs-attribute">key</span>:      <span class="hljs-string">'PREDEFINED.00006'</span>
  <span class="hljs-attribute">readOnly</span>: <span class="hljs-literal">yes</span>
  <span class="hljs-attribute">shortcut</span>: <span class="hljs-string">'M'</span>
  <span class="hljs-attribute">title</span>:    i18n.get <span class="hljs-string">'default_template_markdown'</span>
  <span class="hljs-attribute">usage</span>:    <span class="hljs-number">0</span>
,
  <span class="hljs-attribute">content</span>:  <span class="hljs-string">'{selectionMarkdown}'</span>
  <span class="hljs-attribute">enabled</span>:  <span class="hljs-literal">no</span>
  <span class="hljs-attribute">image</span>:    <span class="hljs-string">'italic'</span>
  <span class="hljs-attribute">index</span>:    <span class="hljs-number">6</span>
  <span class="hljs-attribute">key</span>:      <span class="hljs-string">'PREDEFINED.00007'</span>
  <span class="hljs-attribute">readOnly</span>: <span class="hljs-literal">yes</span>
  <span class="hljs-attribute">shortcut</span>: <span class="hljs-string">'I'</span>
  <span class="hljs-attribute">title</span>:    i18n.get <span class="hljs-string">'default_template_markdown_selection'</span>
  <span class="hljs-attribute">usage</span>:    <span class="hljs-number">0</span>
]</pre></div></div>

        </li>


        <li id="section-5">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Extension ID being used by Template.</p>

            </div>

            <div class="content"><div class='highlight'><pre>EXTENSION_ID      = i18n.get <span class="hljs-string">'@@extension_id'</span></pre></div></div>

        </li>


        <li id="section-6">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Domain of this extension’s homepage.</p>

            </div>

            <div class="content"><div class='highlight'><pre>HOMEPAGE_DOMAIN   = <span class="hljs-string">'template-extension.org'</span></pre></div></div>

        </li>


        <li id="section-7">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>List of known operating systems that could be used by the user.</p>

            </div>

            <div class="content"><div class='highlight'><pre>OPERATING_SYSTEMS = [
  <span class="hljs-attribute">substring</span>: <span class="hljs-string">'Win'</span>
  <span class="hljs-attribute">title</span>:     <span class="hljs-string">'Windows'</span>
,
  <span class="hljs-attribute">substring</span>: <span class="hljs-string">'Mac'</span>
  <span class="hljs-attribute">title</span>:     <span class="hljs-string">'Mac'</span>
,
  <span class="hljs-attribute">substring</span>: <span class="hljs-string">'Linux'</span>
  <span class="hljs-attribute">title</span>:     <span class="hljs-string">'Linux'</span>
]</pre></div></div>

        </li>


        <li id="section-8">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Milliseconds before the popup automatically resets or closes, depending on user preferences.</p>

            </div>

            <div class="content"><div class='highlight'><pre>POPUP_DELAY       = <span class="hljs-number">600</span></pre></div></div>

        </li>


        <li id="section-9">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Regular expression used to extract useful information from different variations of names for tags
that are evaluated/executed later.</p>

            </div>

            <div class="content"><div class='highlight'><pre>R_EXPRESSION_TAG  = <span class="hljs-regexp">/^(select|xpath)(all)?(\S*)?$/</span></pre></div></div>

        </li>


        <li id="section-10">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Regular expression used to detect upper case characters.</p>

            </div>

            <div class="content"><div class='highlight'><pre>R_UPPER_CASE      = <span class="hljs-regexp">/[A-Z]+/</span></pre></div></div>

        </li>


        <li id="section-11">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Very primitive regular expression used to perform simple URL validation.</p>

            </div>

            <div class="content"><div class='highlight'><pre>R_VALID_URL       = <span class="hljs-regexp">/^https?:\/\/\S+\.\S+/i</span></pre></div></div>

        </li>


        <li id="section-12">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Extension ID of the production version of Template.</p>

            </div>

            <div class="content"><div class='highlight'><pre>REAL_EXTENSION_ID = <span class="hljs-string">'dcjnfaoifoefmnbhhlbppaebgnccfddf'</span></pre></div></div>

        </li>


        <li id="section-13">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>List of URL shortener services supported by Template.</p>

            </div>

            <div class="content"><div class='highlight'><pre>SHORTENERS        = [</pre></div></div>

        </li>


        <li id="section-14">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Setup <a href="http://bit.ly">bitly</a>.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">name</span>: <span class="hljs-string">'bitly'</span>
  <span class="hljs-attribute">title</span>: i18n.get <span class="hljs-string">'shortener_bitly'</span>
  <span class="hljs-attribute">method</span>: <span class="hljs-string">'GET'</span>

  <span class="hljs-attribute">getHeaders</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/x-www-form-urlencoded'</span>

  <span class="hljs-attribute">getParameters</span>: <span class="hljs-function"><span class="hljs-params">(url)</span> -&gt;</span>
    params =
      <span class="hljs-attribute">format</span>:  <span class="hljs-string">'json'</span>
      <span class="hljs-attribute">longUrl</span>: url
    <span class="hljs-keyword">if</span> <span class="hljs-property">@oauth</span>.hasAccessToken()
      params.access_token = <span class="hljs-property">@oauth</span>.getAccessToken()
    <span class="hljs-keyword">else</span>
      params.apiKey = ext.config.services.bitly.api_key
      params.login  = ext.config.services.bitly.login
    params

  <span class="hljs-attribute">getUsage</span>: <span class="hljs-function">-&gt;</span>
    store.get <span class="hljs-string">'bitly.usage'</span>

  <span class="hljs-attribute">input</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-literal">null</span>

  <span class="hljs-attribute">isEnabled</span>: <span class="hljs-function">-&gt;</span>
    store.get <span class="hljs-string">'bitly.enabled'</span>

  <span class="hljs-attribute">oauth</span>: <span class="hljs-function">-&gt;</span>
    options = _.pick ext.config.services.bitly, <span class="hljs-string">'client_id'</span>, <span class="hljs-string">'client_secret'</span>
    <span class="hljs-keyword">new</span> OAuth2 <span class="hljs-string">'bitly'</span>, options

  <span class="hljs-attribute">output</span>: <span class="hljs-function"><span class="hljs-params">(resp)</span> -&gt;</span>
    JSON.parse(resp).data.url

  <span class="hljs-attribute">url</span>: <span class="hljs-function">-&gt;</span>
    ext.config.services.bitly.url
,</pre></div></div>

        </li>


        <li id="section-15">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Setup <a href="http://goo.gl">Google URL Shortener</a>.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">name</span>: <span class="hljs-string">'googl'</span>
  <span class="hljs-attribute">title</span>: i18n.get <span class="hljs-string">'shortener_googl'</span>
  <span class="hljs-attribute">method</span>: <span class="hljs-string">'POST'</span>

  <span class="hljs-attribute">getHeaders</span>: <span class="hljs-function">-&gt;</span>
    headers = <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>
    headers.Authorization = <span class="hljs-string">"OAuth <span class="hljs-subst">#{<span class="hljs-property">@oauth</span>.getAccessToken()}</span>"</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@oauth</span>.hasAccessToken()
    headers

  <span class="hljs-attribute">getParameters</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-keyword">unless</span> <span class="hljs-property">@oauth</span>.hasAccessToken()
      <span class="hljs-attribute">key</span>: ext.config.services.googl.api_key

  <span class="hljs-attribute">getUsage</span>: <span class="hljs-function">-&gt;</span>
    store.get <span class="hljs-string">'googl.usage'</span>

  <span class="hljs-attribute">input</span>: <span class="hljs-function"><span class="hljs-params">(url)</span> -&gt;</span>
    JSON.stringify <span class="hljs-attribute">longUrl</span>: url

  <span class="hljs-attribute">isEnabled</span>: <span class="hljs-function">-&gt;</span>
    store.get <span class="hljs-string">'googl.enabled'</span>

  <span class="hljs-attribute">oauth</span>: <span class="hljs-function">-&gt;</span>
    options = _.pick ext.config.services.googl, <span class="hljs-string">'api_scope'</span>, <span class="hljs-string">'client_id'</span>, <span class="hljs-string">'client_secret'</span>
    <span class="hljs-keyword">new</span> OAuth2 <span class="hljs-string">'google'</span>, options

  <span class="hljs-attribute">output</span>: <span class="hljs-function"><span class="hljs-params">(resp)</span> -&gt;</span>
    JSON.parse(resp).id

  <span class="hljs-attribute">url</span>: <span class="hljs-function">-&gt;</span>
    ext.config.services.googl.url
,</pre></div></div>

        </li>


        <li id="section-16">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Setup <a href="http://yourls.org">YOURLS</a>.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">name</span>: <span class="hljs-string">'yourls'</span>
  <span class="hljs-attribute">title</span>: i18n.get <span class="hljs-string">'shortener_yourls'</span>
  <span class="hljs-attribute">method</span>: <span class="hljs-string">'POST'</span>

  <span class="hljs-attribute">getHeaders</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>

  <span class="hljs-attribute">getParameters</span>: <span class="hljs-function"><span class="hljs-params">(url)</span> -&gt;</span>
    params =
      <span class="hljs-attribute">action</span>: <span class="hljs-string">'shorturl'</span>
      <span class="hljs-attribute">format</span>: <span class="hljs-string">'json'</span>
      <span class="hljs-attribute">url</span>:    url

    {authentication, password, signature, username} = store.get <span class="hljs-string">'yourls'</span>
    <span class="hljs-keyword">switch</span> authentication
      <span class="hljs-keyword">when</span> <span class="hljs-string">'advanced'</span>
        params.signature = signature <span class="hljs-keyword">if</span> signature
      <span class="hljs-keyword">when</span> <span class="hljs-string">'basic'</span>
        params.password  = password  <span class="hljs-keyword">if</span> password
        params.username  = username  <span class="hljs-keyword">if</span> username

    params

  <span class="hljs-attribute">getUsage</span>: <span class="hljs-function">-&gt;</span>
    store.get <span class="hljs-string">'yourls.usage'</span>

  <span class="hljs-attribute">input</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-literal">null</span>

  <span class="hljs-attribute">isEnabled</span>: <span class="hljs-function">-&gt;</span>
    store.get <span class="hljs-string">'yourls.enabled'</span>

  <span class="hljs-attribute">output</span>: <span class="hljs-function"><span class="hljs-params">(resp)</span> -&gt;</span>
    JSON.parse(resp).shorturl

  <span class="hljs-attribute">url</span>: <span class="hljs-function">-&gt;</span>
    store.get <span class="hljs-string">'yourls.url'</span>
]</pre></div></div>

        </li>


        <li id="section-17">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>List of extensions supported by Template and used for compatibility purposes.</p>

            </div>

            <div class="content"><div class='highlight'><pre>SUPPORT           =</pre></div></div>

        </li>


        <li id="section-18">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Setup <a href="http://ietab.net">IE Tab</a>.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">hehijbfgiekmjfkfjpbkbammjbdenadd</span>: <span class="hljs-function"><span class="hljs-params">(tab)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> tab.title
      str       = <span class="hljs-string">'IE: '</span>
      idx       = tab.title.indexOf str
      tab.title = tab.title.substring idx + str.length <span class="hljs-keyword">if</span> idx <span class="hljs-keyword">isnt</span> -<span class="hljs-number">1</span>

    <span class="hljs-keyword">if</span> tab.url
      str     = <span class="hljs-string">'iecontainer.html#url='</span>
      idx     = tab.url.indexOf str
      tab.url = decodeURIComponent tab.url.substring idx + str.length <span class="hljs-keyword">if</span> idx <span class="hljs-keyword">isnt</span> -<span class="hljs-number">1</span></pre></div></div>

        </li>


        <li id="section-19">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Setup <a href="http://goo.gl/u7Cau">IE Tab Classic</a>.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">miedgcmlgpmdagojnnbemlkgidepfjfi</span>: <span class="hljs-function"><span class="hljs-params">(tab)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> tab.url
      str     = <span class="hljs-string">'ie.html#'</span>
      idx     = tab.url.indexOf str
      tab.url = tab.url.substring idx + str.length <span class="hljs-keyword">if</span> idx <span class="hljs-keyword">isnt</span> -<span class="hljs-number">1</span></pre></div></div>

        </li>


        <li id="section-20">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Setup <a href="http://iblogbox.com/chrome/ietab">IE Tab Multi (Enhance)</a>.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">fnfnbeppfinmnjnjhedifcfllpcfgeea</span>: <span class="hljs-function"><span class="hljs-params">(tab)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> tab.url
      str = <span class="hljs-string">'navigate.html?chromeurl='</span>
      idx = tab.url.indexOf str
      <span class="hljs-keyword">if</span> idx <span class="hljs-keyword">isnt</span> -<span class="hljs-number">1</span>
        tab.url = tab.url.substring idx + str.length
        str     = <span class="hljs-string">'[escape]'</span>
        tab.url = decodeURIComponent tab.url[str.length..] <span class="hljs-keyword">unless</span> tab.url.indexOf str</pre></div></div>

        </li>


        <li id="section-21">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Setup <a href="http://iblogbox.com/chrome/geckotab">Mozilla Gecko Tab</a>.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">icoloanbecehinobmflpeglknkplbfbm</span>: <span class="hljs-function"><span class="hljs-params">(tab)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> tab.url
      str = <span class="hljs-string">'navigate.html?chromeurl='</span>
      idx = tab.url.indexOf str
      <span class="hljs-keyword">if</span> idx <span class="hljs-keyword">isnt</span> -<span class="hljs-number">1</span>
        tab.url = tab.url.substring idx + str.length
        str     = <span class="hljs-string">'[escape]'</span>
        tab.url = decodeURIComponent tab.url[str.length..] <span class="hljs-keyword">unless</span> tab.url.indexOf str</pre></div></div>

        </li>


        <li id="section-22">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Used by Chrome to represent an unknown language (i.e. one that it couldn’t detect).</p>

            </div>

            <div class="content"><div class='highlight'><pre>UNKNOWN_LOCALE    = <span class="hljs-string">'und'</span></pre></div></div>

        </li>


        <li id="section-23">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h2 id="private-variables">Private variables</h2>

            </div>

        </li>


        <li id="section-24">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Details of the current browser.</p>

            </div>

            <div class="content"><div class='highlight'><pre>browser           =
  <span class="hljs-attribute">title</span>:   <span class="hljs-string">'Chrome'</span>
  <span class="hljs-attribute">version</span>: <span class="hljs-string">''</span></pre></div></div>

        </li>


        <li id="section-25">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Indicate whether or not Template has just been installed.</p>

            </div>

            <div class="content"><div class='highlight'><pre>isNewInstall      = <span class="hljs-literal">no</span></pre></div></div>

        </li>


        <li id="section-26">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Indicate whether or not Template is currently running the production build.</p>

            </div>

            <div class="content"><div class='highlight'><pre>isProductionBuild = EXTENSION_ID <span class="hljs-keyword">is</span> REAL_EXTENSION_ID</pre></div></div>

        </li>


        <li id="section-27">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Name of the user’s operating system.</p>

            </div>

            <div class="content"><div class='highlight'><pre>operatingSystem   = <span class="hljs-string">''</span></pre></div></div>

        </li>


        <li id="section-28">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <h2 id="private-functions">Private functions</h2>

            </div>

        </li>


        <li id="section-29">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Inject and execute the <code>content.coffee</code> and <code>install.coffee</code> scripts within all of the tabs
(where valid) of each Chrome window.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">executeScriptsInExistingWindows</span> = -&gt;</span>
  log.trace()

  chrome.tabs.query {}, <span class="hljs-function"><span class="hljs-params">(tabs)</span> -&gt;</span>
    log.info <span class="hljs-string">'Checking the following tabs for content script execution...'</span>, tabs</pre></div></div>

        </li>


        <li id="section-30">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Check tabs are not displaying a <em>protected</em> page (i.e. one that will cause an error if an
attempt is made to execute content scripts).</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> tab <span class="hljs-keyword">in</span> tabs <span class="hljs-keyword">when</span> <span class="hljs-keyword">not</span> isProtectedPage tab
      chrome.tabs.executeScript tab.id, <span class="hljs-attribute">file</span>: <span class="hljs-string">'lib/content.js'</span></pre></div></div>

        </li>


        <li id="section-31">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Only execute inline installation content script for tabs displaying a page on Template’s
homepage domain.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      chrome.tabs.executeScript tab.id, <span class="hljs-attribute">file</span>: <span class="hljs-string">'lib/install.js'</span> <span class="hljs-keyword">if</span> HOMEPAGE_DOMAIN <span class="hljs-keyword">in</span> tab.url</pre></div></div>

        </li>


        <li id="section-32">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Attempt to derive the current version of the user’s browser.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">getBrowserVersion</span> = -&gt;</span>
  log.trace()

  str = navigator.userAgent
  idx = str.indexOf browser.title
  <span class="hljs-keyword">if</span> idx <span class="hljs-keyword">isnt</span> -<span class="hljs-number">1</span>
    str = str.substring idx + browser.title.length + <span class="hljs-number">1</span>
    idx = str.indexOf <span class="hljs-string">' '</span>
    <span class="hljs-keyword">if</span> idx <span class="hljs-keyword">is</span> -<span class="hljs-number">1</span> <span class="hljs-keyword">then</span> str <span class="hljs-keyword">else</span> str[<span class="hljs-number">0.</span>..idx]</pre></div></div>

        </li>


        <li id="section-33">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Build a list of shortcuts used by enabled templates.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">getHotkeys</span> = -&gt;</span>
  log.trace()

  template.shortcut <span class="hljs-keyword">for</span> template <span class="hljs-keyword">in</span> ext.templates <span class="hljs-keyword">when</span> template.enabled</pre></div></div>

        </li>


        <li id="section-34">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Derive the operating system being used by the user.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">getOperatingSystem</span> = -&gt;</span>
  log.trace()

  <span class="hljs-keyword">return</span> os.title <span class="hljs-keyword">for</span> os <span class="hljs-keyword">in</span> OPERATING_SYSTEMS <span class="hljs-keyword">when</span> os.substring <span class="hljs-keyword">in</span> navigator.platform
  navigator.platform</pre></div></div>

        </li>


        <li id="section-35">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Attempt to retrieve the template with the specified <code>key</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">getTemplateWithKey</span> = <span class="hljs-params">(key)</span> -&gt;</span>
  log.trace()

  _.findWhere ext.templates, {key}</pre></div></div>

        </li>


        <li id="section-36">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Attempt to retrieve the template with the specified <code>menuId</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">getTemplateWithMenuId</span> = <span class="hljs-params">(menuId)</span> -&gt;</span>
  log.trace()

  _.findWhere ext.templates, {menuId}</pre></div></div>

        </li>


        <li id="section-37">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Attempt to retrieve the template with the specified keyboard <code>shortcut</code>.<br>Exclude disabled templates from this query.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">getTemplateWithShortcut</span> = <span class="hljs-params">(shortcut)</span> -&gt;</span>
  log.trace()

  _.findWhere ext.templates, {<span class="hljs-attribute">enabled</span>: <span class="hljs-literal">yes</span>, shortcut}</pre></div></div>

        </li>


        <li id="section-38">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Determine whether or not the identified extension is blacklisted.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">isBlacklisted</span> = <span class="hljs-params">(extensionId)</span> -&gt;</span>
  log.trace()

  <span class="hljs-keyword">return</span> <span class="hljs-literal">yes</span> <span class="hljs-keyword">for</span> extension <span class="hljs-keyword">in</span> BLACKLIST <span class="hljs-keyword">when</span> extension <span class="hljs-keyword">is</span> extensionId
  <span class="hljs-literal">no</span></pre></div></div>

        </li>


        <li id="section-39">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Determine whether or not the specified extension is active on <code>tab</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">isExtensionActive</span> = <span class="hljs-params">(tab, extensionId)</span> -&gt;</span>
  log.trace()

  log.debug <span class="hljs-string">"Checking activity of supported extension '<span class="hljs-subst">#{extensionId}</span>'"</span>

  isSpecialPage(tab) <span class="hljs-keyword">and</span> extensionId <span class="hljs-keyword">in</span> tab.url</pre></div></div>

        </li>


        <li id="section-40">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Determine whether or not <code>tab</code> is currently displaying a <em>protected</em> page (i.e. a page that
content scripts cannot be executed on).</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">isProtectedPage</span> = <span class="hljs-params">(tab)</span> -&gt;</span>
  log.trace()

  isSpecialPage(tab) <span class="hljs-keyword">or</span> isWebStore tab</pre></div></div>

        </li>


        <li id="section-41">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Determine whether or not <code>tab</code> is currently displaying a <em>special</em> page (i.e. a page that is
internal to the browser).</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">isSpecialPage</span> = <span class="hljs-params">(tab)</span> -&gt;</span>
  log.trace()

  <span class="hljs-keyword">return</span> <span class="hljs-literal">yes</span> <span class="hljs-keyword">for</span> protocol <span class="hljs-keyword">in</span> [<span class="hljs-string">'chrome'</span>, <span class="hljs-string">'view-source'</span>] <span class="hljs-keyword">when</span> <span class="hljs-keyword">not</span> tab.url.indexOf protocol
  <span class="hljs-literal">no</span></pre></div></div>

        </li>


        <li id="section-42">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Determine whether or not <code>tab</code> is currently displaying a page on the Chrome Web Store.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">isWebStore</span> = <span class="hljs-params">(tab)</span> -&gt;</span>
  log.trace()

  <span class="hljs-keyword">not</span> tab.url.indexOf <span class="hljs-string">'https://chrome.google.com/webstore'</span></pre></div></div>

        </li>


        <li id="section-43">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Ensure <code>null</code> is returned instead of <code>object</code> if it is <em>empty</em>.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">nullIfEmpty</span> = <span class="hljs-params">(object)</span> -&gt;</span>
  log.trace()

  <span class="hljs-keyword">if</span> _.isEmpty object <span class="hljs-keyword">then</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">else</span> object</pre></div></div>

        </li>


        <li id="section-44">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Listener for internal messages sent to the extension.<br>External messages are also routed through here, but only after being checked that they do not
originate from a blacklisted extension.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">onMessage</span> = <span class="hljs-params">(message, sender, sendResponse)</span> -&gt;</span>
  log.trace()</pre></div></div>

        </li>


        <li id="section-45">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Safely handle callback functionality.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  callback = utils.callback sendResponse</pre></div></div>

        </li>


        <li id="section-46">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Message type is required. Informal rejection.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">do</span> callback <span class="hljs-keyword">unless</span> message.type</pre></div></div>

        </li>


        <li id="section-47">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Don’t allow shortcut requests when shortcuts are disabled.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">do</span> callback <span class="hljs-keyword">if</span> message.type <span class="hljs-keyword">is</span> <span class="hljs-string">'shortcut'</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> store.get <span class="hljs-string">'shortcuts.enabled'</span></pre></div></div>

        </li>


        <li id="section-48">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Select or create a tab for the Options page.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> message.type <span class="hljs-keyword">is</span> <span class="hljs-string">'options'</span>
    selectOrCreateTab utils.url <span class="hljs-string">'pages/options.html'</span></pre></div></div>

        </li>


        <li id="section-49">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Close the popup if it’s currently open. This <em>should</em> happen naturally but is being forced to
ensure consistency.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    chrome.extension.getViews(<span class="hljs-attribute">type</span>: <span class="hljs-string">'popup'</span>)[<span class="hljs-number">0</span>]?.close()
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">do</span> callback</pre></div></div>

        </li>


        <li id="section-50">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Info requests are simple, just send some useful information back. Done!</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> message.type <span class="hljs-keyword">in</span> [<span class="hljs-string">'info'</span>, <span class="hljs-string">'version'</span>]
    <span class="hljs-keyword">return</span> callback
      <span class="hljs-attribute">hotkeys</span>: <span class="hljs-keyword">do</span> getHotkeys
      <span class="hljs-attribute">id</span>:      EXTENSION_ID
      <span class="hljs-attribute">version</span>: ext.version</pre></div></div>

        </li>


        <li id="section-51">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Variables to maintain the various states for this request.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  active       = data   = output   = template = <span class="hljs-literal">null</span>
  editable     = link   = shortcut = <span class="hljs-literal">no</span>
  id           = utils.keyGen <span class="hljs-string">''</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">'t'</span>, <span class="hljs-literal">no</span>
  placeholders = {}

  async.series [
    (done) -&gt;</pre></div></div>

        </li>


        <li id="section-52">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Find the active tab within the current window.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      chrome.tabs.query {<span class="hljs-attribute">active</span>: <span class="hljs-literal">yes</span>, <span class="hljs-attribute">currentWindow</span>: <span class="hljs-literal">yes</span>}, <span class="hljs-function"><span class="hljs-params">(tabs)</span> -&gt;</span>
        log.debug <span class="hljs-string">'Checking the following tabs for the active tab...'</span>, tabs
        active = _.first tabs
        <span class="hljs-keyword">do</span> done

    (done) -&gt;</pre></div></div>

        </li>


        <li id="section-53">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Return a callback function to be used by a tag to indicate that it requires further
action.<br>Replace the tag with the unique placeholder so that it can be rendered again later with the
final value.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function">      <span class="hljs-title">getCallback</span> = <span class="hljs-params">(tag)</span> -&gt;</span>
        (text, render) -&gt;
          text = render text <span class="hljs-keyword">if</span> text
          text = <span class="hljs-property">@url</span>        <span class="hljs-keyword">if</span> tag <span class="hljs-keyword">is</span> <span class="hljs-string">'shorten'</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> text
          trim = text?.trim() <span class="hljs-keyword">or</span> <span class="hljs-string">''</span>
          log.debug <span class="hljs-string">"Following is the contents of a <span class="hljs-subst">#{tag}</span> tag..."</span>, text</pre></div></div>

        </li>


        <li id="section-54">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>If <code>trim</code> doesn’t appear to be a valid so just return the rendered <code>text</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">return</span> text <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> trim <span class="hljs-keyword">or</span> tag <span class="hljs-keyword">is</span> <span class="hljs-string">'shorten'</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> R_VALID_URL.test trim</pre></div></div>

        </li>


        <li id="section-55">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Search for existing placeholder to improve performance later down the line (e.g.
multiple URL shortener requests for the same URL).</p>

            </div>

            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">for</span> own key, val <span class="hljs-keyword">of</span> placeholders
            <span class="hljs-keyword">if</span> val.data <span class="hljs-keyword">is</span> trim <span class="hljs-keyword">and</span> val.tag <span class="hljs-keyword">is</span> tag
              placeholder = key
              <span class="hljs-keyword">break</span></pre></div></div>

        </li>


        <li id="section-56">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Ensure the placeholder is stored correctly for later use.</p>

            </div>

            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">unless</span> placeholder?
            placeholder = utils.keyGen <span class="hljs-string">''</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">'c'</span>, <span class="hljs-literal">no</span>
            placeholders[placeholder] = {<span class="hljs-attribute">data</span>: trim, tag}</pre></div></div>

        </li>


        <li id="section-57">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Sections are re-rendered so the context must have a property for the placeholder the
replaces itself with itself so that it still when it comes to replacing with the
final value.</p>

            </div>

            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">this</span>[placeholder] = <span class="hljs-string">"{<span class="hljs-subst">#{placeholder}</span>}"</span>

          log.debug <span class="hljs-string">"Replacing <span class="hljs-subst">#{tag}</span> tag with <span class="hljs-subst">#{placeholder}</span> placeholder"</span>
          <span class="hljs-string">"{<span class="hljs-subst">#{placeholder}</span>}"</span></pre></div></div>

        </li>


        <li id="section-58">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>If the popup is currently displayed, hide the template list and show a loading animation.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      updateProgress <span class="hljs-literal">null</span>, <span class="hljs-literal">yes</span>

      <span class="hljs-keyword">try</span></pre></div></div>

        </li>


        <li id="section-59">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Attempt to derive the contextual template data.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        template = deriveMessageTempate message
        updateProgress <span class="hljs-number">10</span>

        {data, editable, link, shortcut} = deriveMessageInfo message, active, getCallback
        updateProgress <span class="hljs-number">20</span>

        <span class="hljs-keyword">do</span> done
      <span class="hljs-keyword">catch</span> err</pre></div></div>

        </li>


        <li id="section-60">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Oops! Something went wrong so we should probably let the user know.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        log.error err

        <span class="hljs-keyword">if</span> err <span class="hljs-keyword">instanceof</span> AppError
          done err
        <span class="hljs-keyword">else</span>
          done <span class="hljs-keyword">new</span> AppError <span class="hljs-keyword">if</span> err <span class="hljs-keyword">instanceof</span> URIError
            <span class="hljs-string">'result_bad_uri_description'</span>
          <span class="hljs-keyword">else</span>
            <span class="hljs-string">'result_bad_error_description'</span>

    (done) -&gt;
      updateProgress <span class="hljs-number">30</span></pre></div></div>

        </li>


        <li id="section-61">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Extract additional data from the environment.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      addAdditionalData active, data, id, editable, shortcut, link, <span class="hljs-function">-&gt;</span>
        updateProgress <span class="hljs-number">40</span></pre></div></div>

        </li>


        <li id="section-62">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>To complete the data, simply extend it using <code>template</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        $.extend <span class="hljs-literal">yes</span>, data, {template}</pre></div></div>

        </li>


        <li id="section-63">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Ensure all properties of <code>data</code> are lower case.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        transformData data
        log.debug <span class="hljs-string">"Using the following data to render <span class="hljs-subst">#{template.title}</span>..."</span>, data</pre></div></div>

        </li>


        <li id="section-64">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Render the initial template output based on <code>data</code>.<br>This <em>may</em> be rendered again to replace any temporary placeholders that were inserted.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> template.content
          output = Mustache.render template.content, data
          log.debug <span class="hljs-string">'The following was generated as a result...'</span>, output

        updateProgress <span class="hljs-number">60</span>
        output ?= <span class="hljs-string">''</span>

        <span class="hljs-keyword">do</span> done

    (done) -&gt;
      updateProgress <span class="hljs-number">70</span></pre></div></div>

        </li>


        <li id="section-65">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Only proceed if any placeholders were inserted and replaced, as they need to be handled now
in order to replace any placeholders with their final values.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">do</span> done <span class="hljs-keyword">if</span> _.isEmpty placeholders</pre></div></div>

        </li>


        <li id="section-66">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Maps to populated with relevant data derived from their related stored placeholders.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      expressionMap = {}
      shortenMap    = {}

      <span class="hljs-keyword">for</span> own placeholder, info <span class="hljs-keyword">of</span> placeholders
        <span class="hljs-keyword">if</span> info.tag <span class="hljs-keyword">is</span> <span class="hljs-string">'shorten'</span>
          shortenMap[placeholder] = info.data
        <span class="hljs-keyword">else</span>
          match = info.tag.match R_EXPRESSION_TAG
          <span class="hljs-keyword">if</span> match
            expressionMap[placeholder] =
              <span class="hljs-attribute">all</span>:        match[<span class="hljs-number">2</span>]?
              <span class="hljs-attribute">convertTo</span>:  match[<span class="hljs-number">3</span>]
              <span class="hljs-attribute">expression</span>: info.data
              <span class="hljs-attribute">type</span>:       match[<span class="hljs-number">1</span>]

      async.series [
        (done) -&gt;
          updateProgress <span class="hljs-number">80</span></pre></div></div>

        </li>


        <li id="section-67">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Only proceed if any expression (e.g. <em>select</em>, <em>xpath</em>) placeholders were used.</p>

            </div>

            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">return</span> <span class="hljs-keyword">do</span> done <span class="hljs-keyword">if</span> _.isEmpty expressionMap</pre></div></div>

        </li>


        <li id="section-68">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Evaluate all of the expressions within the <code>active</code> tab and update <code>expressionMap</code> with
the results.</p>

            </div>

            <div class="content"><div class='highlight'><pre>          evaluateExpressions active, expressionMap, <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
            updateProgress <span class="hljs-number">85</span>

            <span class="hljs-keyword">unless</span> err
              log.info <span class="hljs-string">"<span class="hljs-subst">#{_.size expressionMap}</span> expression(s) were evaluated"</span></pre></div></div>

        </li>


        <li id="section-69">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Update the corresponding placeholders with their result.</p>

            </div>

            <div class="content"><div class='highlight'><pre>              placeholders[placeholder] = value <span class="hljs-keyword">for</span> own placeholder, value <span class="hljs-keyword">of</span> expressionMap

            done err

        (done) -&gt;
          updateProgress <span class="hljs-number">90</span></pre></div></div>

        </li>


        <li id="section-70">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Only proceed if any URL shortener placeholders were used.</p>

            </div>

            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">return</span> <span class="hljs-keyword">do</span> done <span class="hljs-keyword">if</span> _.isEmpty shortenMap</pre></div></div>

        </li>


        <li id="section-71">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Call the active URL shortener service for each of the placeholders.</p>

            </div>

            <div class="content"><div class='highlight'><pre>          callUrlShortener shortenMap, <span class="hljs-function"><span class="hljs-params">(err, response)</span> -&gt;</span>
            updateProgress <span class="hljs-number">95</span>

            <span class="hljs-keyword">unless</span> err
              log.info <span class="hljs-string">"URL shortener service was called <span class="hljs-subst">#{_.size shortenMap}</span> time(s)"</span></pre></div></div>

        </li>


        <li id="section-72">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Update the URL shortener service’s usage to ensure captured statistics are
accurate.</p>

            </div>

            <div class="content"><div class='highlight'><pre>              updateUrlShortenerUsage response.service.name, response.oauth</pre></div></div>

        </li>


        <li id="section-73">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Update the corresponding placeholders with their result.</p>

            </div>

            <div class="content"><div class='highlight'><pre>              placeholders[placeholder] = value <span class="hljs-keyword">for</span> own placeholder, value <span class="hljs-keyword">of</span> shortenMap

            done err

      ], <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
        <span class="hljs-keyword">unless</span> err</pre></div></div>

        </li>


        <li id="section-74">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Request(s) were successful so render the output again.</p>

            </div>

            <div class="content"><div class='highlight'><pre>          output = Mustache.render output, placeholders
          log.debug <span class="hljs-string">'The follow was re-generated as a result...'</span>, output

        done err

  ], <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
    updateProgress <span class="hljs-number">100</span></pre></div></div>

        </li>


        <li id="section-75">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Transform message type into a more user-friendly form.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    type = utils.capitalize message.type

    analytics.track <span class="hljs-string">'Requests'</span>, <span class="hljs-string">'Processed'</span>, type, <span class="hljs-keyword">if</span> shortcut <span class="hljs-keyword">then</span> message.data.key.charCodeAt <span class="hljs-number">0</span></pre></div></div>

        </li>


        <li id="section-76">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Ensure that the user is notified if they have attempted to copy an empty string to the system
clipboard.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> err <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> output
      err = <span class="hljs-keyword">new</span> AppError <span class="hljs-string">'result_bad_empty_description'</span>, template.title

    notification = ext.notification

    <span class="hljs-keyword">if</span> err</pre></div></div>

        </li>


        <li id="section-77">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>Notify the user that an error occurred while processing the copy request.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      log.warn err.message

      notification.message = err.message ? i18n.get <span class="hljs-string">'result_bad_description'</span>, template.title
      notification.title   = i18n.get <span class="hljs-string">'result_bad_title'</span>

      <span class="hljs-keyword">do</span> showNotification
    <span class="hljs-keyword">else</span></pre></div></div>

        </li>


        <li id="section-78">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Update the activated template’s usage to ensure captured statistics accurate.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      updateTemplateUsage template.key
      <span class="hljs-keyword">do</span> updateStatistics</pre></div></div>

        </li>


        <li id="section-79">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Notify the user that the copy request was successful once it has been completed.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      notification.message = i18n.get <span class="hljs-string">'result_good_description'</span>, template.title
      notification.title   = i18n.get <span class="hljs-string">'result_good_title'</span>

      ext.copy output</pre></div></div>

        </li>


        <li id="section-80">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>Finally, allow the copied content to be <em>pasted</em> into a field on the active tab.<br>This action is dependant on whether the page is <em>protected</em>, the relevant option is
enabled, and that a field was within the context of the template’s activation.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> isProtectedPage(active) <span class="hljs-keyword">and</span> (editable <span class="hljs-keyword">and</span> store.get <span class="hljs-string">'menu.paste'</span>) <span class="hljs-keyword">or</span>
          (shortcut <span class="hljs-keyword">and</span> store.get <span class="hljs-string">'shortcuts.paste'</span>)
        chrome.tabs.sendMessage active.id, {<span class="hljs-attribute">contents</span>: output, id, <span class="hljs-attribute">type</span>: <span class="hljs-string">'paste'</span>}

    log.debug <span class="hljs-string">"Finished handling a <span class="hljs-subst">#{type}</span> request"</span></pre></div></div>

        </li>


        <li id="section-81">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Listener for external messages sent to the extension.<br>Only messages sent from extensions/apps that have not been previously blacklisted routed to
<code>onMessage</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">onMessageExternal</span> = <span class="hljs-params">(message, sender, sendResponse)</span> -&gt;</span>
  log.trace()</pre></div></div>

        </li>


        <li id="section-82">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>Safely handle callback functionality.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  callback = utils.callback sendResponse</pre></div></div>

        </li>


        <li id="section-83">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>Ensure blacklisted extensions/apps are blocked.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  blocked = isBlacklisted sender.id

  analytics.track <span class="hljs-string">'External Requests'</span>, <span class="hljs-string">'Started'</span>, sender.id, Number !blocked

  <span class="hljs-keyword">if</span> blocked
    log.debug <span class="hljs-string">"Blocked external request from <span class="hljs-subst">#{sender.id}</span>"</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">do</span> callback

  log.debug <span class="hljs-string">"Accepted external request from <span class="hljs-subst">#{sender.id}</span>"</span></pre></div></div>

        </li>


        <li id="section-84">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>Route message as if it was sent internally.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  onMessage message, sender, sendResponse</pre></div></div>

        </li>


        <li id="section-85">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>Avoid repetitive calls to render the text contents of a Mustache section by passed <code>callback</code> the
pre-rendered text and safely handling bad returns.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">rendered</span> = <span class="hljs-params">(callback)</span> -&gt;</span>
  -&gt; (text, render) -&gt;
    result = <span class="hljs-keyword">if</span> arguments.length <span class="hljs-keyword">then</span> callback(render text) <span class="hljs-keyword">else</span> <span class="hljs-keyword">do</span> callback
    result ? <span class="hljs-string">''</span></pre></div></div>

        </li>


        <li id="section-86">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Attempt to select a tab in the current window displaying a page whose location begins with
<code>url</code>.<br>If no existing tab exists a new one is created.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">selectOrCreateTab</span> = <span class="hljs-params">(url, callback)</span> -&gt;</span>
  log.trace()</pre></div></div>

        </li>


        <li id="section-87">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>Retrieve the tabs of last focused window to check for an existing one with a <em>matching</em> URL.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  chrome.windows.getLastFocused <span class="hljs-attribute">populate</span>: <span class="hljs-literal">yes</span>, <span class="hljs-function"><span class="hljs-params">(win)</span> -&gt;</span>
    {tabs} = win

    log.debug <span class="hljs-string">'Checking the tabs of the following last focused window...'</span>, win
    log.debug <span class="hljs-string">'Checking the following tabs for a matching URL...'</span>, tabs</pre></div></div>

        </li>


        <li id="section-88">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Try to find an existing tab that begins with <code>url</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> tab <span class="hljs-keyword">in</span> tabs <span class="hljs-keyword">when</span> <span class="hljs-keyword">not</span> tab.url.indexOf url
      existing = tab
      <span class="hljs-keyword">break</span>

    <span class="hljs-keyword">if</span> existing?</pre></div></div>

        </li>


        <li id="section-89">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>Found one! Now to select it.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      chrome.tabs.update existing.id, <span class="hljs-attribute">active</span>: <span class="hljs-literal">yes</span>
      callback? existing
    <span class="hljs-keyword">else</span></pre></div></div>

        </li>


        <li id="section-90">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>Ach well, let’s just create a brand-spanking new one.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      chrome.tabs.create {<span class="hljs-attribute">windowId</span>: win.id, url, <span class="hljs-attribute">active</span>: <span class="hljs-literal">yes</span>}, <span class="hljs-function"><span class="hljs-params">(tab)</span> -&gt;</span>
        callback? tab</pre></div></div>

        </li>


        <li id="section-91">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>Display a desktop notification informing the user on whether or not the copy request was
successful.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">showNotification</span> = -&gt;</span>
  log.trace()</pre></div></div>

        </li>


        <li id="section-92">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>Ensure that <code>ext</code> is <em>reset</em> and that a notification is only displayed if the user has enabled
the corresponding option (enabled by default).</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> store.get <span class="hljs-string">'notifications.enabled'</span>
    analytics.track <span class="hljs-string">'Frames'</span>, <span class="hljs-string">'Displayed'</span>, <span class="hljs-string">'Notification'</span>

    chrome.notifications.create <span class="hljs-string">''</span>, ext.notification, <span class="hljs-function"><span class="hljs-params">(id)</span> -&gt;</span>
      log.debug <span class="hljs-string">"Opened desktop notification: <span class="hljs-subst">#{id}</span>"</span>

      ext.reset()
  <span class="hljs-keyword">else</span>
    ext.reset()</pre></div></div>

        </li>


        <li id="section-93">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>Reset and hide any visible progress bar on the popup, where possible.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  updateProgress <span class="hljs-literal">null</span>, <span class="hljs-literal">no</span></pre></div></div>

        </li>


        <li id="section-94">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>Convert the <code>html</code> into Markdown using <a href="http://neocotic.com/html.md">html.md</a> while ensuring
related options are used.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">toMarkdown</span> = <span class="hljs-params">(html)</span> -&gt;</span>
  log.trace()

  {inline} = store.get <span class="hljs-string">'markdown'</span>

  md html, {inline}</pre></div></div>

        </li>


        <li id="section-95">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>Update hotkeys stored by the <code>content.coffee</code> script within all of the tabs (where valid) of each
Chrome window.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">updateHotkeys</span> = -&gt;</span>
  log.trace()

  hotkeys = <span class="hljs-keyword">do</span> getHotkeys</pre></div></div>

        </li>


        <li id="section-96">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>Retrieve all open tabs (on all windows) and update their registered keyboard shortcuts.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  chrome.tabs.query {}, <span class="hljs-function"><span class="hljs-params">(tabs)</span> -&gt;</span>
    log.info <span class="hljs-string">'Updating the hotkeys registed in the following tabs...'</span>, tabs</pre></div></div>

        </li>


        <li id="section-97">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>Check tabs are not displaying a <em>protected</em> page (i.e. one that will cause an error if an
attempt is made to send a message to it).</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> tab <span class="hljs-keyword">in</span> tabs <span class="hljs-keyword">when</span> <span class="hljs-keyword">not</span> isProtectedPage tab
      chrome.tabs.sendMessage tab.id, {hotkeys}</pre></div></div>

        </li>


        <li id="section-98">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>Update the popup UI state to reflect the progress of the current request.<br>Ignore <code>percent</code> if <code>toggle</code> is specified; otherwise update the percentage on the progress bar
and reset the delay timer.<br><code>toggle</code> can be used to show the progress bar or reset/close the popup.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">updateProgress</span> = <span class="hljs-params">(percent, toggle)</span> -&gt;</span>
  log.trace()

  popup       = $ chrome.extension.getViews(<span class="hljs-attribute">type</span>: <span class="hljs-string">'popup'</span>)[<span class="hljs-number">0</span>]
  templates   = <span class="hljs-keyword">if</span> popup.length <span class="hljs-keyword">then</span> $ <span class="hljs-string">'#templates'</span>, popup[<span class="hljs-number">0</span>].<span class="hljs-built_in">document</span> <span class="hljs-keyword">else</span> $()
  loading     = <span class="hljs-keyword">if</span> popup.length <span class="hljs-keyword">then</span> $ <span class="hljs-string">'#loading'</span>,   popup[<span class="hljs-number">0</span>].<span class="hljs-built_in">document</span> <span class="hljs-keyword">else</span> $()
  progressBar = loading.find <span class="hljs-string">'.bar'</span>

  <span class="hljs-keyword">if</span> toggle?
    <span class="hljs-keyword">if</span> toggle</pre></div></div>

        </li>


        <li id="section-99">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>Reset the progress bar to zero and ensure it’s visible while the templates are hidden.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      progressBar.css <span class="hljs-string">'width'</span>, <span class="hljs-string">'0%'</span>
      popup.delay            POPUP_DELAY
      templates.hide().delay POPUP_DELAY
      loading.show().delay   POPUP_DELAY
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">if</span> store.get <span class="hljs-string">'toolbar.close'</span></pre></div></div>

        </li>


        <li id="section-100">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>Close the popup, where possible.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        popup.queue -&gt;
          popup.dequeue()[<span class="hljs-number">0</span>]?.close()
      <span class="hljs-keyword">else</span></pre></div></div>

        </li>


        <li id="section-101">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>Reset the progress bar to zero and ensure it’s hidden while the templates are visibile.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        loading.queue -&gt;
          loading.hide().dequeue()
          progressBar.css <span class="hljs-string">'width'</span>, <span class="hljs-string">'0%'</span>
        templates.queue -&gt;
          templates.show().dequeue()
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> percent?</pre></div></div>

        </li>


        <li id="section-102">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>Update the progress bar to display the specified <code>percent</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    log.info <span class="hljs-string">"Updating bar progress to <span class="hljs-subst">#{percent}</span>%"</span>

    popup.dequeue().delay     POPUP_DELAY
    templates.dequeue().delay POPUP_DELAY
    loading.dequeue().delay   POPUP_DELAY
    progressBar.css <span class="hljs-string">'width'</span>, <span class="hljs-string">"<span class="hljs-subst">#{percent}</span>%"</span></pre></div></div>

        </li>


        <li id="section-103">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>Update the statistical information.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">updateStatistics</span> = -&gt;</span>
  log.trace()

  log.info <span class="hljs-string">'Updating statistics'</span>

  store.init <span class="hljs-string">'stats'</span>, {}
  store.modify <span class="hljs-string">'stats'</span>, <span class="hljs-function"><span class="hljs-params">(stats)</span> -&gt;</span></pre></div></div>

        </li>


        <li id="section-104">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>Determine which template has the greatest usage.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    popular = _.max ext.templates, <span class="hljs-function"><span class="hljs-params">(template)</span> -&gt;</span>
      template.usage</pre></div></div>

        </li>


        <li id="section-105">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>Calculate the up-to-date statistical information.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    stats.count       = ext.templates.length
    stats.customCount = stats.count - DEFAULT_TEMPLATES.length
    stats.popular     = popular?.key</pre></div></div>

        </li>


        <li id="section-106">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>Increment the usage for the template with the specified <code>key</code> and persist the changes.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">updateTemplateUsage</span> = <span class="hljs-params">(key)</span> -&gt;</span>
  log.trace()

  template = _.findWhere ext.templates, {key}

  <span class="hljs-keyword">if</span> template?
    template.usage++
    store.set <span class="hljs-string">'templates'</span>, ext.templates

    log.info <span class="hljs-string">"Used the <span class="hljs-subst">#{template.title}</span> template"</span>
    analytics.track <span class="hljs-string">'Templates'</span>, <span class="hljs-string">'Used'</span>, template.title, Number template.readOnly</pre></div></div>

        </li>


        <li id="section-107">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>Increment the usage for the URL shortener service with the specified <code>name</code> and persist the
changes.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">updateUrlShortenerUsage</span> = <span class="hljs-params">(name, oauth)</span> -&gt;</span>
  log.trace()

  shortener = _.findWhere SHORTENERS, {name}

  <span class="hljs-keyword">if</span> shortener?
    store.modify name, <span class="hljs-function"><span class="hljs-params">(shortener)</span> -&gt;</span>
      shortener.usage++

    log.info <span class="hljs-string">"Used the <span class="hljs-subst">#{shortener.title}</span> URL shortener"</span>
    analytics.track <span class="hljs-string">'Shorteners'</span>, <span class="hljs-string">'Used'</span>, shortener.title, Number oauth</pre></div></div>

        </li>


        <li id="section-108">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <h2 id="errors">Errors</h2>

            </div>

        </li>


        <li id="section-109">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p><code>AppError</code> allows easy identification of internal errors.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppError</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Error</span></span></pre></div></div>

        </li>


        <li id="section-110">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>Create a new instance of <code>AppError</code> with a localized message.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(messageKey, substitutions...)</span> -&gt;</span>
    <span class="hljs-property">@message</span> = i18n.get messageKey, substitutions <span class="hljs-keyword">if</span> messageKey</pre></div></div>

        </li>


        <li id="section-111">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <h2 id="data-functions">Data functions</h2>

            </div>

        </li>


        <li id="section-112">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>Extract additional information from <code>tab</code> and add it to <code>data</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">addAdditionalData</span> = <span class="hljs-params">(tab, data, id, editable, shortcut, link, callback)</span> -&gt;</span>
  log.trace()

  async.parallel [
    (done) -&gt;</pre></div></div>

        </li>


        <li id="section-113">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <p>Retrieve all of the URLs from tabs contained in the same window as <code>tab</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      chrome.tabs.query <span class="hljs-attribute">windowId</span>: tab.windowId, <span class="hljs-function"><span class="hljs-params">(tabs)</span> -&gt;</span>
        log.debug <span class="hljs-string">'Extracting the URLs from the following tabs...'</span>,   tabs

        tabs = _.pluck tabs, <span class="hljs-string">'url'</span>

        done <span class="hljs-literal">null</span>, {tabs}

    (done) -&gt;</pre></div></div>

        </li>


        <li id="section-114">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>Allow Chrome to attemt automatic language detection on <code>tab</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      chrome.tabs.detectLanguage tab.id, <span class="hljs-function"><span class="hljs-params">(locale)</span> -&gt;</span>
        log.debug <span class="hljs-string">"Chrome automatically detected language: <span class="hljs-subst">#{locale}</span>"</span>

        locale = <span class="hljs-string">''</span> <span class="hljs-keyword">unless</span> locale <span class="hljs-keyword">and</span> locale <span class="hljs-keyword">isnt</span> UNKNOWN_LOCALE

        done <span class="hljs-literal">null</span>, {locale}

    (done) -&gt;</pre></div></div>

        </li>


        <li id="section-115">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>Retrieve the geolocation from the client.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      navigator.geolocation.getCurrentPosition (position) -&gt;
        log.debug <span class="hljs-string">'Retrieved the following geolocation information...'</span>, position

        done <span class="hljs-literal">null</span>, <span class="hljs-attribute">coords</span>: transformData position.coords, <span class="hljs-literal">yes</span>
      , <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
        log.warn <span class="hljs-string">'Ingoring error thrown when calculating geolocation'</span>, err.message

        done <span class="hljs-literal">null</span>, <span class="hljs-attribute">coords</span>: {}

    (done) -&gt;</pre></div></div>

        </li>


        <li id="section-116">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p>Retrieve all of the cookies the client has stored for the contextual URL.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      chrome.cookies.getAll <span class="hljs-attribute">url</span>: data.url, <span class="hljs-function"><span class="hljs-params">(cookies)</span> -&gt;</span>
        log.debug <span class="hljs-string">'Found the following cookies...'</span>, cookies

        done <span class="hljs-literal">null</span>,
          <span class="hljs-attribute">cookie</span>: rendered (text) -&gt;</pre></div></div>

        </li>


        <li id="section-117">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <p>Attempt to find the value for the cookie name.</p>

            </div>

            <div class="content"><div class='highlight'><pre>            _.findWhere(cookies, <span class="hljs-attribute">name</span>: text)?.value
          <span class="hljs-attribute">cookies</span>: _.chain(cookies).pluck(<span class="hljs-string">'name'</span>).uniq().value()

    (done) -&gt;</pre></div></div>

        </li>


        <li id="section-118">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <p>Try to prevent pages hanging because content script should not have been executed.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">do</span> done <span class="hljs-keyword">if</span> isProtectedPage tab</pre></div></div>

        </li>


        <li id="section-119">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <p>Call the content script running within <code>tab</code> and request additional data to be extracted
from the page’s DOM.<br>The content script also takes this oppertunity to prepare for a second request that may
potentially be sent later instructing it to paste the result of this copy request into a
field within the context of the template’s activation.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      chrome.tabs.sendMessage tab.id, {editable, id, link, shortcut, <span class="hljs-attribute">url</span>: data.url}, <span class="hljs-function"><span class="hljs-params">(response)</span> -&gt;</span>
        log.debug <span class="hljs-string">'The following data was retrieved from the content script...'</span>, response</pre></div></div>

        </li>


        <li id="section-120">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <p>Safety mechanism for when content scripts haven’t been updated along with the extension
so the request gets stuck. This is mainly an issue in development and not production.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        response ?= {}</pre></div></div>

        </li>


        <li id="section-121">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <p>Attempt to transform <code>lastModified</code> into a usable date.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        lastModified = <span class="hljs-keyword">if</span> response.lastModified?
          time = Date.parse response.lastModified
          <span class="hljs-keyword">new</span> Date time <span class="hljs-keyword">unless</span> isNaN time</pre></div></div>

        </li>


        <li id="section-122">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <p>Provide an empty map of meta data if the content script failed to return one.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        metaMap = response.metaMap ? {}</pre></div></div>

        </li>


        <li id="section-123">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              <p>Attempt to lookup the value of the meta data with the specified <code>name</code>.<br>If <code>csv</code> is enabled, separate the contents by commas and return each unique value in an
array.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function">        <span class="hljs-title">getMeta</span> = <span class="hljs-params">(name, csv)</span> -&gt;</span>
          value = metaMap[name]
          <span class="hljs-keyword">if</span> csv <span class="hljs-keyword">and</span> value
            _.chain(value.split <span class="hljs-string">','</span>).compact().uniq().value()
          <span class="hljs-keyword">else</span>
            value <span class="hljs-keyword">or</span> <span class="hljs-string">''</span></pre></div></div>

        </li>


        <li id="section-124">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              <p>Sanitize the <code>response</code> so that it’s data can be cleanly integrated.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        done <span class="hljs-literal">null</span>,
          <span class="hljs-attribute">author</span>:         getMeta <span class="hljs-string">'author'</span>
          <span class="hljs-attribute">characterset</span>:   response.characterSet   ? <span class="hljs-string">''</span>
          <span class="hljs-attribute">description</span>:    getMeta <span class="hljs-string">'description'</span>
          <span class="hljs-attribute">html</span>:           response.html           ? <span class="hljs-string">''</span>
          <span class="hljs-attribute">images</span>:         response.images         ? []
          <span class="hljs-attribute">keywords</span>:       getMeta <span class="hljs-string">'keywords'</span>, <span class="hljs-literal">yes</span>
          <span class="hljs-attribute">lastmodified</span>:   rendered (text) -&gt;
            lastModified?.format <span class="hljs-keyword">if</span> text <span class="hljs-keyword">then</span> text
          <span class="hljs-attribute">linkhtml</span>:       response.linkHTML       ? <span class="hljs-string">''</span>
          <span class="hljs-attribute">links</span>:          response.links          ? []
          <span class="hljs-attribute">linktext</span>:       response.linkText       ? <span class="hljs-string">''</span>
          <span class="hljs-attribute">localstorage</span>:   response.localStorage   ? {}
          <span class="hljs-attribute">meta</span>:           rendered (text) -&gt;
            metaMap[text]
          <span class="hljs-attribute">pageheight</span>:     response.pageHeight     ? <span class="hljs-string">''</span>
          <span class="hljs-attribute">pagewidth</span>:      response.pageWidth      ? <span class="hljs-string">''</span>
          <span class="hljs-attribute">referrer</span>:       response.referrer       ? <span class="hljs-string">''</span>
          <span class="hljs-attribute">scripts</span>:        response.scripts        ? []
          <span class="hljs-attribute">selectedimages</span>: response.selectedImages ? []
          <span class="hljs-attribute">selectedlinks</span>:  response.selectedLinks  ? []
          <span class="hljs-attribute">selection</span>:      response.selection      ? <span class="hljs-string">''</span>
          <span class="hljs-attribute">selectionhtml</span>:  response.selectionHTML  ? <span class="hljs-string">''</span></pre></div></div>

        </li>


        <li id="section-125">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              <p>Deprecated since 1.0.0, use <code>selectedLinks</code> instead.</p>

            </div>

            <div class="content"><div class='highlight'><pre>          <span class="hljs-attribute">selectionlinks</span>: <span class="hljs-function">-&gt;</span> <span class="hljs-property">@selectedlinks</span>
          <span class="hljs-attribute">sessionstorage</span>: response.sessionStorage ? {}
          <span class="hljs-attribute">stylesheets</span>:    response.styleSheets    ? []

  ], <span class="hljs-function"><span class="hljs-params">(err, results = [])</span> -&gt;</span>
    log.error err <span class="hljs-keyword">if</span> err</pre></div></div>

        </li>


        <li id="section-126">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              <p>Extend the original <code>data</code> with any additional data that was retrieved successfully.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    $.extend data, result <span class="hljs-keyword">for</span> result <span class="hljs-keyword">in</span> results <span class="hljs-keyword">when</span> result?

    <span class="hljs-keyword">do</span> callback</pre></div></div>

        </li>


        <li id="section-127">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <p>Creates an object containing data based on information derived from the specified tab and menu
item data.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">buildDerivedData</span> = <span class="hljs-params">(tab, onClickData, getCallback)</span> -&gt;</span>
  log.trace()

  info    = <span class="hljs-attribute">editable</span>: onClickData.editable, <span class="hljs-attribute">link</span>: <span class="hljs-literal">no</span>
  fakeTab =
    <span class="hljs-attribute">title</span>: tab.title
    <span class="hljs-attribute">url</span>:   <span class="hljs-keyword">if</span> onClickData.linkUrl
        info.link = <span class="hljs-literal">yes</span>
        onClickData.linkUrl
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> onClickData.srcUrl   <span class="hljs-keyword">then</span> onClickData.srcUrl
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> onClickData.frameUrl <span class="hljs-keyword">then</span> onClickData.frameUrl
      <span class="hljs-keyword">else</span> onClickData.pageUrl
  info.data = buildStandardData fakeTab, getCallback

  info</pre></div></div>

        </li>


        <li id="section-128">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              <p>Construct a data object based on information extracted from <code>tab</code>.<br>The tab information is then merged with additional information relating to the URL of the tab.<br>If a tag requires further action (e.g. call a URL shortening service) when parsing the templates
contents later, the callback method returned by <code>getCallback</code> is called to handle this as we
don’t want to perform these expensive tasks unless it is actually required.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">buildStandardData</span> = <span class="hljs-params">(tab, getCallback)</span> -&gt;</span>
  log.trace()</pre></div></div>

        </li>


        <li id="section-129">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              <p>Create a clone of the original tab of the tab to run the compatibility scripts on.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  ctab = $.extend {}, tab</pre></div></div>

        </li>


        <li id="section-130">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              <p>Check for any support extensions running on the current tab by simply checking the tabs URL.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span> own extension, handler <span class="hljs-keyword">of</span> SUPPORT <span class="hljs-keyword">when</span> isExtensionActive tab, extension
    log.debug <span class="hljs-string">"Making data compatible with <span class="hljs-subst">#{extension}</span>"</span>

    handler? ctab
    <span class="hljs-keyword">break</span></pre></div></div>

        </li>


        <li id="section-131">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-131">&#182;</a>
              </div>
              <p>Build the initial URL data.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  data = {}
  url  = $.url ctab.url</pre></div></div>

        </li>


        <li id="section-132">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              <p>Create references to the base of all grouped options to improve lookup performance.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  bitly         = store.get <span class="hljs-string">'bitly'</span>
  googl         = store.get <span class="hljs-string">'googl'</span>
  links         = store.get <span class="hljs-string">'links'</span>
  markdown      = store.get <span class="hljs-string">'markdown'</span>
  menu          = store.get <span class="hljs-string">'menu'</span>
  notifications = store.get <span class="hljs-string">'notifications'</span>
  shortcuts     = store.get <span class="hljs-string">'shortcuts'</span>
  stats         = store.get <span class="hljs-string">'stats'</span>
  toolbar       = store.get <span class="hljs-string">'toolbar'</span>
  yourls        = store.get <span class="hljs-string">'yourls'</span></pre></div></div>

        </li>


        <li id="section-133">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-133">&#182;</a>
              </div>
              <p>Attempt to extract the contents from the page source in the specified type (i.e. <code>html</code> or
<code>text</code>).</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function">  <span class="hljs-title">getFromPage</span> = <span class="hljs-params">(source, contentType)</span> -&gt;</span>
    contents = <span class="hljs-string">''</span>

    <span class="hljs-keyword">if</span> source
      html = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'html'</span>
      html.innerHTML = source

      $html = $ html
      $body = $html.find <span class="hljs-string">'body'</span>

      contents = <span class="hljs-keyword">if</span> $body.length <span class="hljs-keyword">then</span> <span class="hljs-keyword">do</span> $body[contentType] <span class="hljs-keyword">else</span> <span class="hljs-keyword">do</span> $html[contentType]

    contents</pre></div></div>

        </li>


        <li id="section-134">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-134">&#182;</a>
              </div>
              <p>Merge the initial data with the attributes of the <a href="https://github.com/allmarkedup/jQuery-URL-Parser">URL
parser</a> and all of the custom Template
properties.<br>All properties should be in lower case so that they can be looked up ignoring case by our
modified version of <a href="https://github.com/janl/mustache.js">mustache.js</a>.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  $.extend data, url.attr(),</pre></div></div>

        </li>


        <li id="section-135">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-135">&#182;</a>
              </div>
              <p>Deprecated since 1.2.5, use <code>linkstarget</code> instead.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">anchortarget</span>:          <span class="hljs-function">-&gt;</span> <span class="hljs-property">@linkstarget</span></pre></div></div>

        </li>


        <li id="section-136">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-136">&#182;</a>
              </div>
              <p>Deprecated since 1.2.5, use <code>linkstitle</code> instead.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">anchortitle</span>:           <span class="hljs-function">-&gt;</span> <span class="hljs-property">@linkstitle</span>
    <span class="hljs-attribute">bitly</span>:                 bitly.enabled
    <span class="hljs-attribute">bitlyaccount</span>:          <span class="hljs-function">-&gt;</span>
      _.findWhere(SHORTENERS, <span class="hljs-attribute">name</span>: <span class="hljs-string">'bitly'</span>).oauth.hasAccessToken()
    <span class="hljs-attribute">browser</span>:               browser.title
    <span class="hljs-attribute">browserversion</span>:        browser.version
    <span class="hljs-attribute">capitalise</span>:            <span class="hljs-function">-&gt;</span> <span class="hljs-keyword">do</span> <span class="hljs-property">@capitalize</span>
    <span class="hljs-attribute">capitalize</span>:            rendered (text) -&gt;
      utils.capitalize text</pre></div></div>

        </li>


        <li id="section-137">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-137">&#182;</a>
              </div>
              <p>Deprecated since 1.0.0, use <code>menu</code> instead.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">contextmenu</span>:           <span class="hljs-function">-&gt;</span> <span class="hljs-property">@menu</span>
    <span class="hljs-attribute">cookiesenabled</span>:        navigator.cookieEnabled
    <span class="hljs-attribute">count</span>:                 stats.count
    <span class="hljs-attribute">customcount</span>:           stats.customCount
    <span class="hljs-attribute">datetime</span>:              rendered (text) -&gt;
      <span class="hljs-keyword">new</span> Date().format <span class="hljs-keyword">if</span> text <span class="hljs-keyword">then</span> text
    <span class="hljs-attribute">decode</span>:                rendered (text) -&gt;
      <span class="hljs-keyword">if</span> text <span class="hljs-keyword">then</span> decodeURIComponent text
    <span class="hljs-attribute">depth</span>:                 screen.colorDepth</pre></div></div>

        </li>


        <li id="section-138">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-138">&#182;</a>
              </div>
              <p>Deprecated since 1.0.0, use <code>linkstarget</code> instead.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">doanchortarget</span>:        <span class="hljs-function">-&gt;</span> <span class="hljs-property">@linkstarget</span></pre></div></div>

        </li>


        <li id="section-139">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-139">&#182;</a>
              </div>
              <p>Deprecated since 1.0.0, use <code>linkstitle</code> instead.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">doanchortitle</span>:         <span class="hljs-function">-&gt;</span> <span class="hljs-property">@linkstitle</span>
    <span class="hljs-attribute">encode</span>:                rendered (text) -&gt;
      <span class="hljs-keyword">if</span> text <span class="hljs-keyword">then</span> encodeURIComponent text</pre></div></div>

        </li>


        <li id="section-140">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-140">&#182;</a>
              </div>
              <p>Deprecated since 0.1.0.2, use <code>encode</code> instead.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">encoded</span>:               <span class="hljs-function">-&gt;</span>
      encodeURIComponent <span class="hljs-property">@url</span>
    <span class="hljs-attribute">escape</span>:                rendered (text) -&gt;
      _.escape text
    <span class="hljs-attribute">favicon</span>:               ctab.favIconUrl
    <span class="hljs-attribute">fparam</span>:                rendered (text) -&gt;
      <span class="hljs-keyword">if</span> text <span class="hljs-keyword">then</span> url.fparam text
    <span class="hljs-attribute">fparams</span>:               nullIfEmpty url.fparam()
    <span class="hljs-attribute">fsegment</span>:              rendered (text) -&gt;
      <span class="hljs-keyword">if</span> text <span class="hljs-keyword">then</span> url.fsegment parseInt text, <span class="hljs-number">10</span>
    <span class="hljs-attribute">fsegments</span>:             url.fsegment()
    <span class="hljs-attribute">googl</span>:                 googl.enabled
    <span class="hljs-attribute">googlaccount</span>:          <span class="hljs-function">-&gt;</span>
      _.findWhere(SHORTENERS, <span class="hljs-attribute">name</span>: <span class="hljs-string">'googl'</span>).oauth.hasAccessToken()</pre></div></div>

        </li>


        <li id="section-141">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-141">&#182;</a>
              </div>
              <p>Deprecated since 1.0.0, use <code>googlaccount</code> instead.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">googloauth</span>:            <span class="hljs-function">-&gt;</span> <span class="hljs-keyword">do</span> <span class="hljs-property">@googlaccount</span>
    <span class="hljs-attribute">java</span>:                  navigator.javaEnabled()
    <span class="hljs-attribute">length</span>:                rendered (text) -&gt;
      text?.length
    <span class="hljs-attribute">linkmarkdown</span>:          <span class="hljs-function">-&gt;</span>
      toMarkdown <span class="hljs-property">@linkhtml</span>
    <span class="hljs-attribute">linkstarget</span>:           links.target
    <span class="hljs-attribute">linkstitle</span>:            links.title
    <span class="hljs-attribute">lowercase</span>:             rendered (text) -&gt;
      text?.toLowerCase()
    <span class="hljs-attribute">markdown</span>:              <span class="hljs-function">-&gt;</span>
      toMarkdown getFromPage <span class="hljs-property">@html</span>, <span class="hljs-string">'html'</span>
    <span class="hljs-attribute">markdowninline</span>:        markdown.inline
    <span class="hljs-attribute">menu</span>:                  menu.enabled
    <span class="hljs-attribute">menuoptions</span>:           menu.options
    <span class="hljs-attribute">menupaste</span>:             menu.paste
    <span class="hljs-attribute">notifications</span>:         notifications.enabled</pre></div></div>

        </li>


        <li id="section-142">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-142">&#182;</a>
              </div>
              <p>Deprecated since 1.2.7</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">notificationduration</span>:  <span class="hljs-number">0</span>
    <span class="hljs-attribute">offline</span>:               <span class="hljs-keyword">not</span> navigator.onLine</pre></div></div>

        </li>


        <li id="section-143">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-143">&#182;</a>
              </div>
              <p>Deprecated since 0.1.0.2, use <code>originalurl</code> instead.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">originalsource</span>:        <span class="hljs-function">-&gt;</span> <span class="hljs-property">@originalurl</span>
    <span class="hljs-attribute">originaltitle</span>:         tab.title <span class="hljs-keyword">or</span> url.attr <span class="hljs-string">'source'</span>
    <span class="hljs-attribute">originalurl</span>:           tab.url
    <span class="hljs-attribute">os</span>:                    operatingSystem
    <span class="hljs-attribute">param</span>:                 rendered (text) -&gt;
      <span class="hljs-keyword">if</span> text <span class="hljs-keyword">then</span> url.param text
    <span class="hljs-attribute">params</span>:                nullIfEmpty url.param()
    <span class="hljs-attribute">plugins</span>:               _.chain(navigator.plugins).pluck(<span class="hljs-string">'name'</span>).uniq().value()
    <span class="hljs-attribute">popular</span>:               $.extend <span class="hljs-literal">yes</span>, {}, _.findWhere ext.templates, <span class="hljs-attribute">key</span>: stats.popular
    <span class="hljs-attribute">screenheight</span>:          screen.height
    <span class="hljs-attribute">screenwidth</span>:           screen.width
    <span class="hljs-attribute">segment</span>:               rendered (text) -&gt;
      <span class="hljs-keyword">if</span> text <span class="hljs-keyword">then</span> url.segment parseInt text, <span class="hljs-number">10</span>
    <span class="hljs-attribute">segments</span>:              url.segment()
    <span class="hljs-attribute">select</span>:                <span class="hljs-function">-&gt;</span>
      getCallback <span class="hljs-string">'select'</span>
    <span class="hljs-attribute">selectall</span>:             <span class="hljs-function">-&gt;</span>
      getCallback <span class="hljs-string">'selectall'</span>
    <span class="hljs-attribute">selectallhtml</span>:         <span class="hljs-function">-&gt;</span>
      getCallback <span class="hljs-string">'selectallhtml'</span>
    <span class="hljs-attribute">selectallmarkdown</span>:     <span class="hljs-function">-&gt;</span>
      getCallback <span class="hljs-string">'selectallmarkdown'</span>
    <span class="hljs-attribute">selecthtml</span>:            <span class="hljs-function">-&gt;</span>
      getCallback <span class="hljs-string">'selecthtml'</span>
    <span class="hljs-attribute">selectionmarkdown</span>:     <span class="hljs-function">-&gt;</span>
      toMarkdown <span class="hljs-property">@selectionhtml</span>
    <span class="hljs-attribute">selectmarkdown</span>:        <span class="hljs-function">-&gt;</span>
      getCallback <span class="hljs-string">'selectmarkdown'</span></pre></div></div>

        </li>


        <li id="section-144">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-144">&#182;</a>
              </div>
              <p>Deprecated since 1.0.0, use <code>shorten</code> instead.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">short</span>:                 <span class="hljs-function">-&gt;</span> <span class="hljs-keyword">do</span> <span class="hljs-property">@shorten</span>
    <span class="hljs-attribute">shortcuts</span>:             shortcuts.enabled
    <span class="hljs-attribute">shortcutspaste</span>:        shortcuts.paste
    <span class="hljs-attribute">shorten</span>:               <span class="hljs-function">-&gt;</span>
      getCallback <span class="hljs-string">'shorten'</span>
    <span class="hljs-attribute">text</span>:                  <span class="hljs-function">-&gt;</span>
      getFromPage <span class="hljs-property">@html</span>, <span class="hljs-string">'text'</span>
    <span class="hljs-attribute">tidy</span>:                  rendered (text) -&gt;
      <span class="hljs-keyword">if</span> text <span class="hljs-keyword">then</span> text.replace(<span class="hljs-regexp">/([ \t]+)/g</span>, <span class="hljs-string">' '</span>).trim()
    <span class="hljs-attribute">title</span>:                 ctab.title <span class="hljs-keyword">or</span> url.attr <span class="hljs-string">'source'</span>
    <span class="hljs-attribute">toolbarclose</span>:          toolbar.close</pre></div></div>

        </li>


        <li id="section-145">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-145">&#182;</a>
              </div>
              <p>Deprecated since 1.0.0, use the inverse of <code>toolbarpopup</code> instead.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">toolbarfeature</span>:        <span class="hljs-function">-&gt;</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@toolbarpopup</span></pre></div></div>

        </li>


        <li id="section-146">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-146">&#182;</a>
              </div>
              <p>Deprecated since 1.0.0, use <code>toolbarstyle</code> instead.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">toolbarfeaturedetails</span>: <span class="hljs-function">-&gt;</span> <span class="hljs-property">@toolbarstyle</span></pre></div></div>

        </li>


        <li id="section-147">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-147">&#182;</a>
              </div>
              <p>Deprecated since 1.0.0, use <code>toolbarkey</code> instead.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">toolbarfeaturename</span>:    <span class="hljs-function">-&gt;</span> <span class="hljs-property">@toolbarkey</span>
    <span class="hljs-attribute">toolbarkey</span>:            toolbar.key
    <span class="hljs-attribute">toolbaroptions</span>:        toolbar.options
    <span class="hljs-attribute">toolbarpopup</span>:          toolbar.popup</pre></div></div>

        </li>


        <li id="section-148">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-148">&#182;</a>
              </div>
              <p>Obsolete since 1.1.0, functionality has been removed.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">toolbarstyle</span>:          <span class="hljs-literal">no</span>
    <span class="hljs-attribute">trim</span>:                  rendered (text) -&gt;
      text?.trim()
    <span class="hljs-attribute">trimleft</span>:              rendered (text) -&gt;
      text?.trimLeft()
    <span class="hljs-attribute">trimright</span>:             rendered (text) -&gt;
      text?.trimRight()
    <span class="hljs-attribute">unescape</span>:              rendered (text) -&gt;
      _.unescape text
    <span class="hljs-attribute">uppercase</span>:             rendered (text) -&gt;
      text?.toUpperCase()
    <span class="hljs-attribute">url</span>:                   url.attr <span class="hljs-string">'source'</span>
    <span class="hljs-attribute">version</span>:               ext.version
    <span class="hljs-attribute">wordcount</span>:             rendered (text) -&gt;
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> text</pre></div></div>

        </li>


        <li id="section-149">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-149">&#182;</a>
              </div>
              <p>Oddly, this is the optimal method to calculate the word count on WebKit browsers.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      count   = <span class="hljs-number">0</span>
      text    = text.trim()
      matches = text.match <span class="hljs-regexp">/\s+/g</span>

      <span class="hljs-keyword">if</span> text
        count++
        count+= matches.length <span class="hljs-keyword">if</span> matches

      count
    <span class="hljs-attribute">xpath</span>:                <span class="hljs-function">-&gt;</span>
      getCallback <span class="hljs-string">'xpath'</span>
    <span class="hljs-attribute">xpathall</span>:             <span class="hljs-function">-&gt;</span>
      getCallback <span class="hljs-string">'xpathall'</span>
    <span class="hljs-attribute">xpathallhtml</span>:         <span class="hljs-function">-&gt;</span>
      getCallback <span class="hljs-string">'xpathallhtml'</span>
    <span class="hljs-attribute">xpathallmarkdown</span>:     <span class="hljs-function">-&gt;</span>
      getCallback <span class="hljs-string">'xpathallmarkdown'</span>
    <span class="hljs-attribute">xpathhtml</span>:            <span class="hljs-function">-&gt;</span>
      getCallback <span class="hljs-string">'xpathhtml'</span>
    <span class="hljs-attribute">xpathmarkdown</span>:        <span class="hljs-function">-&gt;</span>
      getCallback <span class="hljs-string">'xpathmarkdown'</span>
    <span class="hljs-attribute">yourls</span>:                yourls.enabled
    <span class="hljs-attribute">yourlsauthentication</span>:  yourls.authentication
    <span class="hljs-attribute">yourlspassword</span>:        yourls.password
    <span class="hljs-attribute">yourlssignature</span>:       yourls.signature
    <span class="hljs-attribute">yourlsurl</span>:             yourls.url
    <span class="hljs-attribute">yourlsusername</span>:        yourls.username

  data</pre></div></div>

        </li>


        <li id="section-150">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-150">&#182;</a>
              </div>
              <p>Derive the relevant information, including the template data, based on both <code>message</code> and <code>tab</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">deriveMessageInfo</span> = <span class="hljs-params">(message, tab, getCallback)</span> -&gt;</span>
  log.trace()

  info =
    <span class="hljs-attribute">data</span>:     <span class="hljs-literal">null</span>
    <span class="hljs-attribute">editable</span>: <span class="hljs-literal">no</span>
    <span class="hljs-attribute">link</span>:     <span class="hljs-literal">no</span>
    <span class="hljs-attribute">shortcut</span>: <span class="hljs-literal">no</span>

  $.extend info, <span class="hljs-keyword">switch</span> message.type
    <span class="hljs-keyword">when</span> <span class="hljs-string">'menu'</span>
      buildDerivedData tab, message.data, getCallback
    <span class="hljs-keyword">when</span> <span class="hljs-string">'popup'</span>, <span class="hljs-string">'toolbar'</span>
      <span class="hljs-attribute">data</span>: buildStandardData tab, getCallback
    <span class="hljs-keyword">when</span> <span class="hljs-string">'shortcut'</span>
      <span class="hljs-attribute">data</span>:     buildStandardData tab, getCallback
      <span class="hljs-attribute">shortcut</span>: <span class="hljs-literal">yes</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> AppError <span class="hljs-string">'result_bad_type_description'</span></pre></div></div>

        </li>


        <li id="section-151">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-151">&#182;</a>
              </div>
              <p>Derive the relevant template based on the context of <code>message</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">deriveMessageTempate</span> = <span class="hljs-params">(message)</span> -&gt;</span>
  log.trace()

  template = <span class="hljs-keyword">switch</span> message.type
    <span class="hljs-keyword">when</span> <span class="hljs-string">'menu'</span>             <span class="hljs-keyword">then</span> getTemplateWithMenuId message.data.menuItemId
    <span class="hljs-keyword">when</span> <span class="hljs-string">'popup'</span>, <span class="hljs-string">'toolbar'</span> <span class="hljs-keyword">then</span> getTemplateWithKey message.data.key
    <span class="hljs-keyword">when</span> <span class="hljs-string">'shortcut'</span>         <span class="hljs-keyword">then</span> getTemplateWithShortcut message.data.key
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> AppError <span class="hljs-string">'result_bad_type_description'</span>
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> AppError <span class="hljs-string">'result_bad_template_description'</span> <span class="hljs-keyword">unless</span> template?

  template</pre></div></div>

        </li>


        <li id="section-152">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-152">&#182;</a>
              </div>
              <p>Evaluate the expressions in <code>map</code> within the content scripts in <code>tab</code> in order to obtain their
corresponding values.<br>Expressions can be of mixed type (i.e. CSS selector, XPath expression) and contain different
instructions depending on the tag that was used by the user.<br><code>callback</code> will be called with the result once all of the expressions have been evaluated.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">evaluateExpressions</span> = <span class="hljs-params">(tab, map, callback)</span> -&gt;</span>
  log.trace()</pre></div></div>

        </li>


        <li id="section-153">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-153">&#182;</a>
              </div>
              <p>Since content scripts cannot be executed on <em>protected</em> pages attempting to send a message to
one would result in background errors being thrown, so we’ll just have to make sure the
placeholder is removed.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> isProtectedPage tab
    map[placeholder] = <span class="hljs-string">''</span> <span class="hljs-keyword">for</span> own placeholder <span class="hljs-keyword">of</span> map
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">do</span> callback</pre></div></div>

        </li>


        <li id="section-154">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-154">&#182;</a>
              </div>
              <p>Tell the content script in <code>tab</code> to evaluate all of the expressions in <code>map</code> and update it with
their corresponding values.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  chrome.tabs.sendMessage tab.id, <span class="hljs-attribute">expressions</span>: map, <span class="hljs-function"><span class="hljs-params">(response)</span> -&gt;</span>
    log.debug <span class="hljs-string">'The following response was returned by the content script...'</span>, response

    response ?= {}

    <span class="hljs-keyword">for</span> own placeholder, expression <span class="hljs-keyword">of</span> response.expressions
      {convertTo, error, result} = expression

      <span class="hljs-keyword">break</span> <span class="hljs-keyword">if</span> error

      result <span class="hljs-keyword">or</span>= <span class="hljs-string">''</span>
      result   = result.join <span class="hljs-string">'\n'</span> <span class="hljs-keyword">if</span> _.isArray result
      result   = toMarkdown result <span class="hljs-keyword">if</span> convertTo <span class="hljs-keyword">is</span> <span class="hljs-string">'markdown'</span>

      map[placeholder] = result

    callback <span class="hljs-keyword">if</span> error <span class="hljs-keyword">then</span> <span class="hljs-keyword">new</span> AppError <span class="hljs-string">'result_bad_expression_description'</span></pre></div></div>

        </li>


        <li id="section-155">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-155">&#182;</a>
              </div>
              <p>Ensure there is a lower case variant of all properties of <code>data</code>, optionally only changing a
clone of the specified <code>data</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">transformData</span> = <span class="hljs-params">(data, clone)</span> -&gt;</span>
  log.trace()

  <span class="hljs-keyword">return</span> data <span class="hljs-keyword">unless</span> data</pre></div></div>

        </li>


        <li id="section-156">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-156">&#182;</a>
              </div>
              <p>Ensure that the <code>result</code> and <code>data</code> types match when cloning.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  result = <span class="hljs-keyword">if</span> clone
    <span class="hljs-keyword">if</span> _.isArray data <span class="hljs-keyword">then</span> [] <span class="hljs-keyword">else</span> {}
  <span class="hljs-keyword">else</span>
    data
<span class="hljs-function">

  <span class="hljs-title">transform</span> = <span class="hljs-params">(value)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> _.isArray(value) <span class="hljs-keyword">or</span> _.isObject(value) <span class="hljs-keyword">then</span> transformData value, clone <span class="hljs-keyword">else</span> value

  <span class="hljs-keyword">if</span> _.isArray result</pre></div></div>

        </li>


        <li id="section-157">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-157">&#182;</a>
              </div>
              <p>Also transform any nested objects deep within the array.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    result[i] = transform value <span class="hljs-keyword">for</span> value, i <span class="hljs-keyword">in</span> data
  <span class="hljs-keyword">else</span></pre></div></div>

        </li>


        <li id="section-158">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-158">&#182;</a>
              </div>
              <p>Transform all properties of the object, included any deep nested objects.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> own prop, value <span class="hljs-keyword">of</span> data
      prop = prop.toLowerCase() <span class="hljs-keyword">if</span> clone <span class="hljs-keyword">or</span> R_UPPER_CASE.test prop

      result[prop] = transform value

  result</pre></div></div>

        </li>


        <li id="section-159">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-159">&#182;</a>
              </div>
              <h2 id="configuration-functions">Configuration functions</h2>

            </div>

        </li>


        <li id="section-160">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-160">&#182;</a>
              </div>
              <p>Transform specific sections of the data loaded from <code>configuration.json</code> so that they’re more
usable and localized.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">buildConfig</span> = -&gt;</span>
  log.trace()

  <span class="hljs-keyword">do</span> buildIcons</pre></div></div>

        </li>


        <li id="section-161">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-161">&#182;</a>
              </div>
              <p>Transform the configuration icons into usable <code>Icon</code> instances.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">buildIcons</span> = -&gt;</span>
  log.trace()

  <span class="hljs-keyword">for</span> name, i <span class="hljs-keyword">in</span> ext.config.icons.current
    ext.config.icons.current[i] = <span class="hljs-keyword">new</span> Icon name</pre></div></div>

        </li>


        <li id="section-162">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-162">&#182;</a>
              </div>
              <h2 id="html-building-functions">HTML building functions</h2>

            </div>

        </li>


        <li id="section-163">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-163">&#182;</a>
              </div>
              <p>Build the HTML to populate the popup with to optimize popup loading times.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">buildPopup</span> = -&gt;</span>
  log.trace()</pre></div></div>

        </li>


        <li id="section-164">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-164">&#182;</a>
              </div>
              <p>Generate the HTML for each enabled template.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  items = $()
  items = items.add buildTemplate template <span class="hljs-keyword">for</span> template <span class="hljs-keyword">in</span> ext.templates <span class="hljs-keyword">when</span> template.enabled</pre></div></div>

        </li>


        <li id="section-165">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-165">&#182;</a>
              </div>
              <p>Add a generic message to state the obvious… that the list is empty.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  unless items.length
    message = " #{i18n.get 'empty'}"
    items   = items.add $('&lt;li/&gt;', class: 'empty').append($ '&lt;i/&gt;', class: 'icon-').append message</pre></div></div>

        </li>


        <li id="section-166">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-166">&#182;</a>
              </div>
              <p>Add a link to the options page if the user doesn’t mind.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  if store.get 'toolbar.options'
    anchor = $ '&lt;a/&gt;',
      class:       'options'
      'data-type': 'options'

    anchor.append $ '&lt;i/&gt;', class: Icon.get('cog').style
    anchor.append " #{i18n.get 'options'}"

    items = items.add $ '&lt;li/&gt;', class: 'divider'
    items = items.add $('&lt;li/&gt;').append anchor

  ext.templatesHtml = $('&lt;div/&gt;').append(items).html()</pre></div></div>

        </li>


        <li id="section-167">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-167">&#182;</a>
              </div>
              <p>Create an <code>li</code> element to represent <code>template</code>.<br>The element should then be inserted in to the <code>ul</code> element in the popup page but is created here
to optimize display times for the popup.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">buildTemplate</span> = <span class="hljs-params">(template)</span> -&gt;</span>
  log.trace()

  log.debug <span class="hljs-string">"Creating popup list item for the <span class="hljs-subst">#{template.title}</span> template"</span>

  anchor = $ <span class="hljs-string">'&lt;a/&gt;'</span>,
    <span class="hljs-string">'data-key'</span>:  template.key
    <span class="hljs-string">'data-type'</span>: <span class="hljs-string">'popup'</span></pre></div></div>

        </li>


        <li id="section-168">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-168">&#182;</a>
              </div>
              <p>Ensure keyboard shortcuts are displayed correctly, where appropriate.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  if template.shortcut and store.get 'shortcuts.enabled'
    anchor.append $ '&lt;span/&gt;',
      class: 'pull-right muted shortcut',
      html:  "#{ext.modifiers()}#{template.shortcut}"

  anchor.append $ '&lt;i/&gt;', class: Icon.get(template.image, yes).style
  anchor.append " #{template.title}"

  $('&lt;li/&gt;').append anchor</pre></div></div>

        </li>


        <li id="section-169">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-169">&#182;</a>
              </div>
              <h2 id="initialization-functions">Initialization functions</h2>

            </div>

        </li>


        <li id="section-170">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-170">&#182;</a>
              </div>
              <p>Handle the conversion/removal of older version of settings that may have been stored previously
by <code>ext.init</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">init_update</span> = -&gt;</span>
  log.trace()</pre></div></div>

        </li>


        <li id="section-171">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-171">&#182;</a>
              </div>
              <p>Update the update progress indicator itself.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> store.exists <span class="hljs-string">'update_progress'</span>
    store.modify <span class="hljs-string">'updates'</span>, <span class="hljs-function"><span class="hljs-params">(updates)</span> -&gt;</span>
      <span class="hljs-keyword">for</span> own namespace, versions <span class="hljs-keyword">of</span> store.remove <span class="hljs-string">'update_progress'</span>
        updates[namespace] = <span class="hljs-keyword">if</span> versions?.length <span class="hljs-keyword">then</span> versions.pop() <span class="hljs-keyword">else</span> <span class="hljs-string">''</span></pre></div></div>

        </li>


        <li id="section-172">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-172">&#182;</a>
              </div>
              <p>Create an updater for the <code>settings</code> namespace.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  updater      = <span class="hljs-keyword">new</span> store.Updater <span class="hljs-string">'settings'</span>
  updater.<span class="hljs-literal">on</span> <span class="hljs-string">'update'</span>, <span class="hljs-function"><span class="hljs-params">(version)</span> -&gt;</span>
    log.info <span class="hljs-string">"Updating general settings for <span class="hljs-subst">#{version}</span>"</span>

  isNewInstall = updater.isNew</pre></div></div>

        </li>


        <li id="section-173">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-173">&#182;</a>
              </div>
              <p>Define the processes for all required updates to the <code>settings</code> namespace.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  updater.update <span class="hljs-string">'0.1.0.0'</span>, <span class="hljs-function">-&gt;</span>
    store.rename <span class="hljs-string">'settingNotification'</span>,      <span class="hljs-string">'notifications'</span>,        <span class="hljs-literal">on</span>
    store.rename <span class="hljs-string">'settingNotificationTimer'</span>, <span class="hljs-string">'notificationDuration'</span>, <span class="hljs-number">3000</span>
    store.rename <span class="hljs-string">'settingShortcut'</span>,          <span class="hljs-string">'shortcuts'</span>,            <span class="hljs-literal">on</span>
    store.rename <span class="hljs-string">'settingTargetAttr'</span>,        <span class="hljs-string">'doAnchorTarget'</span>,       <span class="hljs-literal">off</span>
    store.rename <span class="hljs-string">'settingTitleAttr'</span>,         <span class="hljs-string">'doAnchorTitle'</span>,        <span class="hljs-literal">off</span>
    store.remove <span class="hljs-string">'settingIeTabExtract'</span>,      <span class="hljs-string">'settingIeTabTitle'</span>

  updater.update <span class="hljs-string">'1.0.0'</span>, <span class="hljs-function">-&gt;</span>
    <span class="hljs-keyword">if</span> store.exists <span class="hljs-string">'options_active_tab'</span>
      optionsActiveTab = store.get <span class="hljs-string">'options_active_tab'</span>
      store.set <span class="hljs-string">'options_active_tab'</span>, <span class="hljs-keyword">switch</span> optionsActiveTab
        <span class="hljs-keyword">when</span> <span class="hljs-string">'features_nav'</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'templates_nav'</span>
        <span class="hljs-keyword">when</span> <span class="hljs-string">'toolbar_nav'</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'general_nav'</span>
        <span class="hljs-keyword">else</span> optionsActiveTab

    store.modify <span class="hljs-string">'links'</span>, <span class="hljs-function"><span class="hljs-params">(links)</span> -&gt;</span>
      links.target = store.get(<span class="hljs-string">'doAnchorTarget'</span>) ? <span class="hljs-literal">off</span>
      links.title  = store.get(<span class="hljs-string">'doAnchorTitle'</span>)  ? <span class="hljs-literal">off</span>
    store.remove <span class="hljs-string">'doAnchorTarget'</span>, <span class="hljs-string">'doAnchorTitle'</span>

    store.modify <span class="hljs-string">'menu'</span>, <span class="hljs-function"><span class="hljs-params">(menu)</span> -&gt;</span>
      menu.enabled = store.get(<span class="hljs-string">'contextMenu'</span>) ? <span class="hljs-literal">yes</span>
    store.remove <span class="hljs-string">'contextMenu'</span>

    store.set <span class="hljs-string">'notifications'</span>,
      <span class="hljs-attribute">duration</span>: store.get(<span class="hljs-string">'notificationDuration'</span>) ? <span class="hljs-number">3000</span>
      <span class="hljs-attribute">enabled</span>:  store.get(<span class="hljs-string">'notifications'</span>)        ? <span class="hljs-literal">yes</span>
    store.remove <span class="hljs-string">'notificationDuration'</span>

  updater.update <span class="hljs-string">'1.1.0'</span>, <span class="hljs-function">-&gt;</span>
    store.set <span class="hljs-string">'shortcuts'</span>, <span class="hljs-attribute">enabled</span>: store.get(<span class="hljs-string">'shortcuts'</span>) ? <span class="hljs-literal">yes</span>

  updater.update <span class="hljs-string">'1.2.3'</span>, <span class="hljs-function">-&gt;</span>
    store.modify <span class="hljs-string">'logger'</span>, <span class="hljs-function"><span class="hljs-params">(logger)</span> -&gt;</span>
      <span class="hljs-keyword">delete</span> logger.Enabled
      <span class="hljs-keyword">delete</span> logger.Level

    store.modify <span class="hljs-string">'menu'</span>, <span class="hljs-function"><span class="hljs-params">(menu)</span> -&gt;</span>
      <span class="hljs-keyword">delete</span> menu.Enabled
      <span class="hljs-keyword">delete</span> menu.Options
      <span class="hljs-keyword">delete</span> menu.Paste

    store.modify <span class="hljs-string">'notifications'</span>, <span class="hljs-function"><span class="hljs-params">(notifications)</span> -&gt;</span>
      <span class="hljs-keyword">delete</span> notifications.Duration
      <span class="hljs-keyword">delete</span> notifications.Enabled

    store.modify <span class="hljs-string">'shortcuts'</span>, <span class="hljs-function"><span class="hljs-params">(shortcuts)</span> -&gt;</span>
      <span class="hljs-keyword">delete</span> shortcuts.Enabled
      <span class="hljs-keyword">delete</span> shortcuts.Paste

    store.modify <span class="hljs-string">'toolbar'</span>, <span class="hljs-function"><span class="hljs-params">(toolbar)</span> -&gt;</span>
      <span class="hljs-keyword">delete</span> toolbar.Close
      <span class="hljs-keyword">delete</span> toolbar.Key
      <span class="hljs-keyword">delete</span> toolbar.Options

  updater.update <span class="hljs-string">'1.2.5'</span>, <span class="hljs-function">-&gt;</span>
    store.modify <span class="hljs-string">'links'</span>, <span class="hljs-function"><span class="hljs-params">(links)</span> -&gt;</span>
      anchor = store.get(<span class="hljs-string">'anchor'</span>) ? {}
      links.target = anchor.target ? <span class="hljs-literal">off</span>
      links.title  = anchor.title  ? <span class="hljs-literal">off</span>
    store.remove <span class="hljs-string">'anchor'</span>

  updater.update <span class="hljs-string">'1.2.7'</span>, <span class="hljs-function">-&gt;</span>
    store.modify <span class="hljs-string">'notifications'</span>, <span class="hljs-function"><span class="hljs-params">(notifications)</span> -&gt;</span>
      <span class="hljs-keyword">delete</span> notifications.duration</pre></div></div>

        </li>


        <li id="section-174">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-174">&#182;</a>
              </div>
              <p>Initialize the settings related to statistical information.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">initStatistics</span> = -&gt;</span>
  log.trace()

  <span class="hljs-keyword">do</span> updateStatistics</pre></div></div>

        </li>


        <li id="section-175">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-175">&#182;</a>
              </div>
              <p>Initialize <code>template</code> and its properties, before adding it to <code>templates</code> to be persisted later.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">initTemplate</span> = <span class="hljs-params">(template, templates)</span> -&gt;</span>
  log.trace()</pre></div></div>

        </li>


        <li id="section-176">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-176">&#182;</a>
              </div>
              <p>Derive the index of <code>template</code> to determine whether or not it already exists.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  idx = templates.indexOf _.findWhere templates, <span class="hljs-attribute">key</span>: template.key

  <span class="hljs-keyword">if</span> idx <span class="hljs-keyword">is</span> -<span class="hljs-number">1</span></pre></div></div>

        </li>


        <li id="section-177">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-177">&#182;</a>
              </div>
              <p><code>template</code> doesn’t already exist so add it now.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    log.debug <span class="hljs-string">'Adding the following predefined template...'</span>, template

    templates.push template
  <span class="hljs-keyword">else</span></pre></div></div>

        </li>


        <li id="section-178">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-178">&#182;</a>
              </div>
              <p><code>template</code> exists so modify the properties to ensure they are reliable.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    log.debug <span class="hljs-string">'Ensuring following template adheres to structure...'</span>, template

    <span class="hljs-keyword">if</span> template.readOnly</pre></div></div>

        </li>


        <li id="section-179">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-179">&#182;</a>
              </div>
              <p><code>template</code> is read-only so certain properties should always be overriden and others only
when they are not already available.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      templates[idx].content   = template.content
      templates[idx].enabled  ?= template.enabled
      templates[idx].image    ?= template.image
      templates[idx].index    ?= template.index
      templates[idx].key       = template.key
      templates[idx].readOnly  = <span class="hljs-literal">yes</span>
      templates[idx].shortcut ?= template.shortcut
      templates[idx].title     = template.title
      templates[idx].usage    ?= template.usage
    <span class="hljs-keyword">else</span></pre></div></div>

        </li>


        <li id="section-180">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-180">&#182;</a>
              </div>
              <p><code>template</code> is <em>not</em> read-only so set unavailable, but required, properties to their default
value.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      templates[idx].content  ?= <span class="hljs-string">''</span>
      templates[idx].enabled  ?= <span class="hljs-literal">yes</span>
      templates[idx].image    ?= <span class="hljs-string">''</span>
      templates[idx].index    ?= <span class="hljs-number">0</span>
      templates[idx].key      ?= template.key
      templates[idx].readOnly  = <span class="hljs-literal">no</span>
      templates[idx].shortcut ?= <span class="hljs-string">''</span>
      templates[idx].title    ?= <span class="hljs-string">'?'</span>
      templates[idx].usage    ?= <span class="hljs-number">0</span>

    template = templates[idx]

  template</pre></div></div>

        </li>


        <li id="section-181">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-181">&#182;</a>
              </div>
              <p>Initialize the persisted managed templates.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">initTemplates</span> = -&gt;</span>
  log.trace()

  <span class="hljs-keyword">do</span> initTemplates_update

  store.modify <span class="hljs-string">'templates'</span>, <span class="hljs-function"><span class="hljs-params">(templates)</span> -&gt;</span></pre></div></div>

        </li>


        <li id="section-182">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-182">&#182;</a>
              </div>
              <p>Initialize all default templates to ensure their properties are as expected.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    initTemplate template, templates <span class="hljs-keyword">for</span> template <span class="hljs-keyword">in</span> DEFAULT_TEMPLATES</pre></div></div>

        </li>


        <li id="section-183">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-183">&#182;</a>
              </div>
              <p>Now, initialize <em>all</em> templates to ensure their properties are valid.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    initTemplate template, templates <span class="hljs-keyword">for</span> template <span class="hljs-keyword">in</span> templates

  ext.updateTemplates()</pre></div></div>

        </li>


        <li id="section-184">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-184">&#182;</a>
              </div>
              <p>Handle the conversion/removal of older version of settings that may have been stored previously
by <code>initTemplates</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">initTemplates_update</span> = -&gt;</span>
  log.trace()</pre></div></div>

        </li>


        <li id="section-185">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-185">&#182;</a>
              </div>
              <p>Create updater for the <code>features</code> namespace and then rename it to <code>templates</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  updater = <span class="hljs-keyword">new</span> store.Updater <span class="hljs-string">'features'</span>
  updater.<span class="hljs-literal">on</span> <span class="hljs-string">'update'</span>, <span class="hljs-function"><span class="hljs-params">(version)</span> -&gt;</span>
    log.info <span class="hljs-string">"Updating template settings for <span class="hljs-subst">#{version}</span>"</span>
  updater.rename <span class="hljs-string">'templates'</span></pre></div></div>

        </li>


        <li id="section-186">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-186">&#182;</a>
              </div>
              <p>Define the processes for all required updates to the <code>templates</code> namespace.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  updater.update <span class="hljs-string">'0.1.0.0'</span>, <span class="hljs-function">-&gt;</span>
    store.rename <span class="hljs-string">'copyAnchorEnabled'</span>,  <span class="hljs-string">'feat__anchor_enabled'</span>,  <span class="hljs-literal">yes</span>
    store.rename <span class="hljs-string">'copyAnchorOrder'</span>,    <span class="hljs-string">'feat__anchor_index'</span>,    <span class="hljs-number">2</span>
    store.rename <span class="hljs-string">'copyBBCodeEnabled'</span>,  <span class="hljs-string">'feat__bbcode_enabled'</span>,  <span class="hljs-literal">no</span>
    store.rename <span class="hljs-string">'copyBBCodeOrder'</span>,    <span class="hljs-string">'feat__bbcode_index'</span>,    <span class="hljs-number">4</span>
    store.rename <span class="hljs-string">'copyEncodedEnabled'</span>, <span class="hljs-string">'feat__encoded_enabled'</span>, <span class="hljs-literal">yes</span>
    store.rename <span class="hljs-string">'copyEncodedOrder'</span>,   <span class="hljs-string">'feat__encoded_index'</span>,   <span class="hljs-number">3</span>
    store.rename <span class="hljs-string">'copyShortEnabled'</span>,   <span class="hljs-string">'feat__short_enabled'</span>,   <span class="hljs-literal">yes</span>
    store.rename <span class="hljs-string">'copyShortOrder'</span>,     <span class="hljs-string">'feat__short_index'</span>,     <span class="hljs-number">1</span>
    store.rename <span class="hljs-string">'copyUrlEnabled'</span>,     <span class="hljs-string">'feat__url_enabled'</span>,     <span class="hljs-literal">yes</span>
    store.rename <span class="hljs-string">'copyUrlOrder'</span>,       <span class="hljs-string">'feat__url_index'</span>,       <span class="hljs-number">0</span>

  updater.update <span class="hljs-string">'0.2.0.0'</span>, <span class="hljs-function">-&gt;</span>
    names = store.get(<span class="hljs-string">'features'</span>) ? []

    <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> names <span class="hljs-keyword">when</span> _.isString name
      store.rename <span class="hljs-string">"feat_<span class="hljs-subst">#{name}</span>_template"</span>, <span class="hljs-string">"feat_<span class="hljs-subst">#{name}</span>_content"</span>

      image = store.get <span class="hljs-string">"feat_<span class="hljs-subst">#{name}</span>_image"</span>

      <span class="hljs-keyword">if</span> _.isString image
        <span class="hljs-keyword">if</span> image <span class="hljs-keyword">in</span> [<span class="hljs-string">''</span>, <span class="hljs-string">'spacer.gif'</span>, <span class="hljs-string">'spacer.png'</span>]
          store.set <span class="hljs-string">"feat_<span class="hljs-subst">#{name}</span>_image"</span>, <span class="hljs-number">0</span>
        <span class="hljs-keyword">else</span>
          <span class="hljs-keyword">for</span> legacy, i <span class="hljs-keyword">in</span> ext.config.icons.legacy
            <span class="hljs-keyword">if</span> <span class="hljs-string">"<span class="hljs-subst">#{legacy.name.replace <span class="hljs-regexp">/^tmpl/</span>, <span class="hljs-string">'feat'</span>}</span>.png"</span> <span class="hljs-keyword">is</span> image
              store.set <span class="hljs-string">"feat_<span class="hljs-subst">#{name}</span>_image"</span>, i + <span class="hljs-number">1</span>
              <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">else</span>
        store.set <span class="hljs-string">"feat_<span class="hljs-subst">#{name}</span>_image"</span>, <span class="hljs-number">0</span>

  updater.update <span class="hljs-string">'1.0.0'</span>, <span class="hljs-function">-&gt;</span>
    names              = store.remove(<span class="hljs-string">'features'</span>) ? []
    templates          = []

    toolbarFeatureName = store.get <span class="hljs-string">'toolbarFeatureName'</span>

    <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> names <span class="hljs-keyword">when</span> _.isString name
      image = store.remove(<span class="hljs-string">"feat_<span class="hljs-subst">#{name}</span>_image"</span>) ? <span class="hljs-number">0</span>
      image = <span class="hljs-keyword">if</span> --image &gt;= <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> Icon.fromLegacy(image)?.name <span class="hljs-keyword">or</span> <span class="hljs-string">''</span> <span class="hljs-keyword">else</span> <span class="hljs-string">''</span>

      key = ext.getKeyForName name

      <span class="hljs-keyword">if</span> toolbarFeatureName <span class="hljs-keyword">is</span> name
        <span class="hljs-keyword">if</span> store.exists <span class="hljs-string">'toolbar'</span>
          store.modify <span class="hljs-string">'toolbar'</span>, <span class="hljs-function"><span class="hljs-params">(toolbar)</span> -&gt;</span>
            toolbar.key = key
        <span class="hljs-keyword">else</span>
          store.set <span class="hljs-string">'toolbar'</span>, <span class="hljs-attribute">key</span>: key

      templates.push
        <span class="hljs-attribute">content</span>:  store.remove(<span class="hljs-string">"feat_<span class="hljs-subst">#{name}</span>_content"</span>)  ? <span class="hljs-string">''</span>
        <span class="hljs-attribute">enabled</span>:  store.remove(<span class="hljs-string">"feat_<span class="hljs-subst">#{name}</span>_enabled"</span>)  ? <span class="hljs-literal">yes</span>
        <span class="hljs-attribute">image</span>:    image
        <span class="hljs-attribute">index</span>:    store.remove(<span class="hljs-string">"feat_<span class="hljs-subst">#{name}</span>_index"</span>)    ? <span class="hljs-number">0</span>
        <span class="hljs-attribute">key</span>:      key
        <span class="hljs-attribute">readOnly</span>: store.remove(<span class="hljs-string">"feat_<span class="hljs-subst">#{name}</span>_readonly"</span>) ? <span class="hljs-literal">no</span>
        <span class="hljs-attribute">shortcut</span>: store.remove(<span class="hljs-string">"feat_<span class="hljs-subst">#{name}</span>_shortcut"</span>) ? <span class="hljs-string">''</span>
        <span class="hljs-attribute">title</span>:    store.remove(<span class="hljs-string">"feat_<span class="hljs-subst">#{name}</span>_title"</span>)    ? <span class="hljs-string">'?'</span>
        <span class="hljs-attribute">usage</span>:    <span class="hljs-number">0</span>

    store.set <span class="hljs-string">'templates'</span>, templates
    store.remove store.search(<span class="hljs-regexp">/^feat_.*_(content|enabled|image|index|readonly|shortcut|title)$/</span>)...

  updater.update <span class="hljs-string">'1.1.0'</span>, <span class="hljs-function">-&gt;</span>
    store.modify <span class="hljs-string">'templates'</span>, <span class="hljs-function"><span class="hljs-params">(templates)</span> -&gt;</span>
      <span class="hljs-keyword">for</span> template <span class="hljs-keyword">in</span> templates
        <span class="hljs-keyword">if</span> template.readOnly
          <span class="hljs-keyword">break</span> <span class="hljs-keyword">for</span> base <span class="hljs-keyword">in</span> DEFAULT_TEMPLATES <span class="hljs-keyword">when</span> base.key <span class="hljs-keyword">is</span> template.key

          template.image = <span class="hljs-keyword">switch</span> template.key
            <span class="hljs-keyword">when</span> <span class="hljs-string">'PREDEFINED.00001'</span>
              <span class="hljs-keyword">if</span> template.image <span class="hljs-keyword">is</span> <span class="hljs-string">'tmpl_globe'</span> <span class="hljs-keyword">then</span> base.image
              <span class="hljs-keyword">else</span> Icon.fromLegacy(template.image)?.name <span class="hljs-keyword">or</span> <span class="hljs-string">''</span>
            <span class="hljs-keyword">when</span> <span class="hljs-string">'PREDEFINED.00002'</span>
              <span class="hljs-keyword">if</span> template.image <span class="hljs-keyword">is</span> <span class="hljs-string">'tmpl_link'</span> <span class="hljs-keyword">then</span> base.image
              <span class="hljs-keyword">else</span> Icon.fromLegacy(template.image)?.name <span class="hljs-keyword">or</span> <span class="hljs-string">''</span>
            <span class="hljs-keyword">when</span> <span class="hljs-string">'PREDEFINED.00003'</span>
              <span class="hljs-keyword">if</span> template.image <span class="hljs-keyword">is</span> <span class="hljs-string">'tmpl_html'</span> <span class="hljs-keyword">then</span> base.image
              <span class="hljs-keyword">else</span> Icon.fromLegacy(template.image)?.name <span class="hljs-keyword">or</span> <span class="hljs-string">''</span>
            <span class="hljs-keyword">when</span> <span class="hljs-string">'PREDEFINED.00004'</span>
              <span class="hljs-keyword">if</span> template.image <span class="hljs-keyword">is</span> <span class="hljs-string">'tmpl_component'</span> <span class="hljs-keyword">then</span> base.image
              <span class="hljs-keyword">else</span> Icon.fromLegacy(template.image)?.name <span class="hljs-keyword">or</span> <span class="hljs-string">''</span>
            <span class="hljs-keyword">when</span> <span class="hljs-string">'PREDEFINED.00005'</span>
              <span class="hljs-keyword">if</span> template.image <span class="hljs-keyword">is</span> <span class="hljs-string">'tmpl_discussion'</span> <span class="hljs-keyword">then</span> base.image
              <span class="hljs-keyword">else</span> Icon.fromLegacy(template.image)?.name <span class="hljs-keyword">or</span> <span class="hljs-string">''</span>
            <span class="hljs-keyword">when</span> <span class="hljs-string">'PREDEFINED.00006'</span>
              <span class="hljs-keyword">if</span> template.image <span class="hljs-keyword">is</span> <span class="hljs-string">'tmpl_discussion'</span> <span class="hljs-keyword">then</span> base.image
              <span class="hljs-keyword">else</span> Icon.fromLegacy(template.image)?.name <span class="hljs-keyword">or</span> <span class="hljs-string">''</span>
            <span class="hljs-keyword">when</span> <span class="hljs-string">'PREDEFINED.00007'</span>
              <span class="hljs-keyword">if</span> template.image <span class="hljs-keyword">is</span> <span class="hljs-string">'tmpl_note'</span> <span class="hljs-keyword">then</span> base.image
              <span class="hljs-keyword">else</span> Icon.fromLegacy(template.image)?.name <span class="hljs-keyword">or</span> <span class="hljs-string">''</span>
            <span class="hljs-keyword">else</span> base.image
        <span class="hljs-keyword">else</span>
          template.image = Icon.fromLegacy(template.image)?.name <span class="hljs-keyword">or</span> <span class="hljs-string">''</span></pre></div></div>

        </li>


        <li id="section-187">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-187">&#182;</a>
              </div>
              <p>Initialize the settings related to the toolbar/browser action.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">initToolbar</span> = -&gt;</span>
  log.trace()

  <span class="hljs-keyword">do</span> initToolbar_update

  store.modify <span class="hljs-string">'toolbar'</span>, <span class="hljs-function"><span class="hljs-params">(toolbar)</span> -&gt;</span>
    toolbar.close   ?= <span class="hljs-literal">yes</span>
    toolbar.key     ?= <span class="hljs-string">'PREDEFINED.00001'</span>
    toolbar.options ?= <span class="hljs-literal">yes</span>
    toolbar.popup   ?= <span class="hljs-literal">yes</span>

  ext.updateToolbar()</pre></div></div>

        </li>


        <li id="section-188">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-188">&#182;</a>
              </div>
              <p>Handle the conversion/removal of older version of settings that may have been stored previously
by <code>initToolbar</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">initToolbar_update</span> = -&gt;</span>
  log.trace()</pre></div></div>

        </li>


        <li id="section-189">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-189">&#182;</a>
              </div>
              <p>Create updater for the <code>toolbar</code> namespace.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  updater = <span class="hljs-keyword">new</span> store.Updater <span class="hljs-string">'toolbar'</span>
  updater.<span class="hljs-literal">on</span> <span class="hljs-string">'update'</span>, <span class="hljs-function"><span class="hljs-params">(version)</span> -&gt;</span>
    log.info <span class="hljs-string">"Updating toolbar settings for <span class="hljs-subst">#{version}</span>"</span></pre></div></div>

        </li>


        <li id="section-190">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-190">&#182;</a>
              </div>
              <p>Define the processes for all required updates to the <code>toolbar</code> namespace.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  updater.update <span class="hljs-string">'1.0.0'</span>, <span class="hljs-function">-&gt;</span>
    store.modify <span class="hljs-string">'toolbar'</span>, <span class="hljs-function"><span class="hljs-params">(toolbar)</span> -&gt;</span>
      toolbar.popup = store.get(<span class="hljs-string">'toolbarPopup'</span>) ? <span class="hljs-literal">yes</span>
      toolbar.style = store.get(<span class="hljs-string">'toolbarFeatureDetails'</span>) ? <span class="hljs-literal">no</span>
    store.remove <span class="hljs-string">'toolbarFeature'</span>, <span class="hljs-string">'toolbarFeatureDetails'</span>, <span class="hljs-string">'toolbarFeatureName'</span>, <span class="hljs-string">'toolbarPopup'</span>

  updater.update <span class="hljs-string">'1.1.0'</span>, <span class="hljs-function">-&gt;</span>
    store.modify <span class="hljs-string">'toolbar'</span>, <span class="hljs-function"><span class="hljs-params">(toolbar)</span> -&gt;</span>
      <span class="hljs-keyword">delete</span> toolbar.style</pre></div></div>

        </li>


        <li id="section-191">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-191">&#182;</a>
              </div>
              <p>Initialize the settings related to the supported URL Shortener services.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">initUrlShorteners</span> = -&gt;</span>
  log.trace()

  store.init
    <span class="hljs-attribute">bitly</span>:  {}
    <span class="hljs-attribute">googl</span>:  {}
    <span class="hljs-attribute">yourls</span>: {}

  <span class="hljs-keyword">do</span> initUrlShorteners_update

  store.modify <span class="hljs-string">'bitly'</span>, <span class="hljs-function"><span class="hljs-params">(bitly)</span> -&gt;</span>
    bitly.enabled ?= <span class="hljs-literal">yes</span>
    bitly.usage   ?= <span class="hljs-number">0</span>

  store.modify <span class="hljs-string">'googl'</span>, <span class="hljs-function"><span class="hljs-params">(googl)</span> -&gt;</span>
    googl.enabled ?= <span class="hljs-literal">no</span>
    googl.usage   ?= <span class="hljs-number">0</span>

  store.modify <span class="hljs-string">'yourls'</span>, <span class="hljs-function"><span class="hljs-params">(yourls)</span> -&gt;</span>
    yourls.authentication ?= <span class="hljs-string">''</span>
    yourls.enabled        ?= <span class="hljs-literal">no</span>
    yourls.password       ?= <span class="hljs-string">''</span>
    yourls.signature      ?= <span class="hljs-string">''</span>
    yourls.url            ?= <span class="hljs-string">''</span>
    yourls.username       ?= <span class="hljs-string">''</span>
    yourls.usage          ?= <span class="hljs-number">0</span></pre></div></div>

        </li>


        <li id="section-192">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-192">&#182;</a>
              </div>
              <p>Handle the conversion/removal of older version of settings that may have been stored previously
by <code>initUrlShorteners</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">initUrlShorteners_update</span> = -&gt;</span>
  log.trace()</pre></div></div>

        </li>


        <li id="section-193">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-193">&#182;</a>
              </div>
              <p>Create updater for the <code>shorteners</code> namespace.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  updater = <span class="hljs-keyword">new</span> store.Updater <span class="hljs-string">'shorteners'</span>
  updater.<span class="hljs-literal">on</span> <span class="hljs-string">'update'</span>, <span class="hljs-function"><span class="hljs-params">(version)</span> -&gt;</span>
    log.info <span class="hljs-string">"Updating URL shortener settings for <span class="hljs-subst">#{version}</span>"</span></pre></div></div>

        </li>


        <li id="section-194">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-194">&#182;</a>
              </div>
              <p>Define the processes for all required updates to the <code>shorteners</code> namespace.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  updater.update <span class="hljs-string">'0.1.0.0'</span>, <span class="hljs-function">-&gt;</span>
    store.rename <span class="hljs-string">'bitlyEnabled'</span>,       <span class="hljs-string">'bitly'</span>,         <span class="hljs-literal">yes</span>
    store.rename <span class="hljs-string">'bitlyXApiKey'</span>,       <span class="hljs-string">'bitlyApiKey'</span>,   <span class="hljs-string">''</span>
    store.rename <span class="hljs-string">'bitlyXLogin'</span>,        <span class="hljs-string">'bitlyUsername'</span>, <span class="hljs-string">''</span>
    store.rename <span class="hljs-string">'googleEnabled'</span>,      <span class="hljs-string">'googl'</span>,         <span class="hljs-literal">no</span>
    store.rename <span class="hljs-string">'googleOAuthEnabled'</span>, <span class="hljs-string">'googlOAuth'</span>,    <span class="hljs-literal">yes</span>

  updater.update <span class="hljs-string">'1.0.0'</span>, <span class="hljs-function">-&gt;</span>
    bitly = store.get <span class="hljs-string">'bitly'</span>
    store.set <span class="hljs-string">'bitly'</span>,
      <span class="hljs-attribute">apiKey</span>:    store.get(<span class="hljs-string">'bitlyApiKey'</span>)   ? <span class="hljs-string">''</span>
      <span class="hljs-attribute">enabled</span>:   <span class="hljs-keyword">if</span> _.isBoolean bitly <span class="hljs-keyword">then</span> bitly <span class="hljs-keyword">else</span> <span class="hljs-literal">yes</span>
      <span class="hljs-attribute">username</span>:  store.get(<span class="hljs-string">'bitlyUsername'</span>) ? <span class="hljs-string">''</span>
    store.remove <span class="hljs-string">'bitlyApiKey'</span>, <span class="hljs-string">'bitlyUsername'</span>

    googl = store.get <span class="hljs-string">'googl'</span>
    store.set <span class="hljs-string">'googl'</span>,
      <span class="hljs-attribute">enabled</span>: <span class="hljs-keyword">if</span> _.isBoolean googl <span class="hljs-keyword">then</span> googl <span class="hljs-keyword">else</span> <span class="hljs-literal">no</span>
    store.remove <span class="hljs-string">'googlOAuth'</span>

    yourls = store.get <span class="hljs-string">'yourls'</span>
    store.set <span class="hljs-string">'yourls'</span>,
      <span class="hljs-attribute">enabled</span>:   <span class="hljs-keyword">if</span> _.isBoolean yourls <span class="hljs-keyword">then</span> yourls <span class="hljs-keyword">else</span> <span class="hljs-literal">no</span>
      <span class="hljs-attribute">password</span>:  store.get(<span class="hljs-string">'yourlsPassword'</span>)  ? <span class="hljs-string">''</span>
      <span class="hljs-attribute">signature</span>: store.get(<span class="hljs-string">'yourlsSignature'</span>) ? <span class="hljs-string">''</span>
      <span class="hljs-attribute">url</span>:       store.get(<span class="hljs-string">'yourlsUrl'</span>)       ? <span class="hljs-string">''</span>
      <span class="hljs-attribute">username</span>:  store.get(<span class="hljs-string">'yourlsUsername'</span>)  ? <span class="hljs-string">''</span>
    store.remove <span class="hljs-string">'yourlsPassword'</span>, <span class="hljs-string">'yourlsSignature'</span>, <span class="hljs-string">'yourlsUrl'</span>, <span class="hljs-string">'yourlsUsername'</span>

  updater.update <span class="hljs-string">'1.0.1'</span>, <span class="hljs-function">-&gt;</span>
    store.modify <span class="hljs-string">'bitly'</span>, <span class="hljs-function"><span class="hljs-params">(bitly)</span> -&gt;</span>
      <span class="hljs-keyword">delete</span> bitly.apiKey
      <span class="hljs-keyword">delete</span> bitly.username

    store.modify <span class="hljs-string">'yourls'</span>, <span class="hljs-function"><span class="hljs-params">(yourls)</span> -&gt;</span>
      yourls.authentication = <span class="hljs-keyword">if</span> yourls.signature <span class="hljs-keyword">then</span> <span class="hljs-string">'advanced'</span>
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> yourls.password <span class="hljs-keyword">and</span> yourls.username <span class="hljs-keyword">then</span> <span class="hljs-string">'basic'</span>
      <span class="hljs-keyword">else</span> <span class="hljs-string">''</span>

    store.remove store.search(<span class="hljs-regexp">/^oauth_token.*/</span>)...

  updater.update <span class="hljs-string">'1.2.3'</span>, <span class="hljs-function">-&gt;</span>
    store.modify <span class="hljs-string">'yourls'</span>, <span class="hljs-function"><span class="hljs-params">(yourls)</span> -&gt;</span>
      <span class="hljs-keyword">delete</span> yourls.Password
      <span class="hljs-keyword">delete</span> yourls.Signature
      <span class="hljs-keyword">delete</span> yourls.Url
      <span class="hljs-keyword">delete</span> yourls.Username</pre></div></div>

        </li>


        <li id="section-195">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-195">&#182;</a>
              </div>
              <h2 id="url-shortener-functions">URL shortener functions</h2>

            </div>

        </li>


        <li id="section-196">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-196">&#182;</a>
              </div>
              <p>Call the active URL shortener service for each URL in <code>map</code> in order to obtain their
corresponding short URLs.<br><code>callback</code> will be called with the result once all URLs have been shortened or an error is
encountered.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">callUrlShortener</span> = <span class="hljs-params">(map, callback)</span> -&gt;</span>
  log.trace()

  service  = <span class="hljs-keyword">do</span> getActiveUrlShortener
  endpoint = service.url()
  oauth    = <span class="hljs-literal">no</span>
  title    = service.title</pre></div></div>

        </li>


        <li id="section-197">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-197">&#182;</a>
              </div>
              <p>Ensure the service URL exists in case it is user-defined (e.g. YOURLS).</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> callback <span class="hljs-keyword">new</span> AppError <span class="hljs-string">'shortener_config_error'</span>, title <span class="hljs-keyword">unless</span> endpoint

  tasks = []
  _.each map, <span class="hljs-function"><span class="hljs-params">(url, placeholder)</span> -&gt;</span>
    oauth = !!service.oauth?.hasAccessToken()

    tasks.push (done) -&gt;
      async.series [
        (done) -&gt;</pre></div></div>

        </li>


        <li id="section-198">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-198">&#182;</a>
              </div>
              <p>Ensure the OAuth adapter has been authorized.</p>

            </div>

            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> oauth
            service.oauth.authorize -&gt;
              <span class="hljs-keyword">do</span> done
          <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">do</span> done

        (done) -&gt;
          params    = service.getParameters url
          endpoint += <span class="hljs-string">"?<span class="hljs-subst">#{$.param params}</span>"</span> <span class="hljs-keyword">if</span> params?</pre></div></div>

        </li>


        <li id="section-199">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-199">&#182;</a>
              </div>
              <p>Build the HTTP asynchronous request for the URL shortener service.</p>

            </div>

            <div class="content"><div class='highlight'><pre>          xhr = <span class="hljs-keyword">new</span> XMLHttpRequest()
          xhr.open service.method, endpoint, <span class="hljs-literal">yes</span></pre></div></div>

        </li>


        <li id="section-200">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-200">&#182;</a>
              </div>
              <p>Allow service to populate request headers.</p>

            </div>

            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">for</span> own header, value <span class="hljs-keyword">of</span> service.getHeaders() ? {}
            xhr.setRequestHeader header, value

          xhr.onreadystatechange = <span class="hljs-function">-&gt;</span></pre></div></div>

        </li>


        <li id="section-201">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-201">&#182;</a>
              </div>
              <p>Wait for the response and let the service handle it before passing the result back.</p>

            </div>

            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> xhr.readyState <span class="hljs-keyword">is</span> <span class="hljs-number">4</span>
              <span class="hljs-keyword">if</span> xhr.status <span class="hljs-keyword">is</span> <span class="hljs-number">200</span>
                map[placeholder] = service.output xhr.responseText
                <span class="hljs-keyword">do</span> done
              <span class="hljs-keyword">else</span></pre></div></div>

        </li>


        <li id="section-202">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-202">&#182;</a>
              </div>
              <p>Something went wrong so let’s tell the user.</p>

            </div>

            <div class="content"><div class='highlight'><pre>                done <span class="hljs-keyword">new</span> AppError <span class="hljs-string">'shortener_detailed_error'</span>, title, url</pre></div></div>

        </li>


        <li id="section-203">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-203">&#182;</a>
              </div>
              <p>Finally, send the HTTP request.</p>

            </div>

            <div class="content"><div class='highlight'><pre>          xhr.send service.input url

      ], done
  async.series tasks, <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> err
      err.message <span class="hljs-keyword">or</span>= i18n.get <span class="hljs-string">'shortener_error'</span>, service.title
      callback err
    <span class="hljs-keyword">else</span>
      callback <span class="hljs-literal">null</span>, {oauth, service}</pre></div></div>

        </li>


        <li id="section-204">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-204">&#182;</a>
              </div>
              <p>Retrieve the active URL shortener service.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">getActiveUrlShortener</span> = -&gt;</span>
  log.trace()</pre></div></div>

        </li>


        <li id="section-205">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-205">&#182;</a>
              </div>
              <p>Attempt to lookup enabled URL shortener service.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  shortener = _.find SHORTENERS, <span class="hljs-function"><span class="hljs-params">(shortener)</span> -&gt;</span>
    shortener.isEnabled()

  <span class="hljs-keyword">unless</span> shortener?</pre></div></div>

        </li>


        <li id="section-206">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-206">&#182;</a>
              </div>
              <p>Should never reach here but we’ll return bit.ly service by default after ensuring it’s the
active URL shortener service from now on to save some time in the future.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    store.modify <span class="hljs-string">'bitly'</span>, <span class="hljs-function"><span class="hljs-params">(bitly)</span> -&gt;</span>
      bitly.enabled = <span class="hljs-literal">yes</span>
    shortener = <span class="hljs-keyword">do</span> getActiveUrlShortener

  log.debug <span class="hljs-string">"Getting details for <span class="hljs-subst">#{shortener.title}</span> URL shortener"</span>

  shortener</pre></div></div>

        </li>


        <li id="section-207">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-207">&#182;</a>
              </div>
              <h2 id="background-page-setup">Background page setup</h2>

            </div>

            <div class="content"><div class='highlight'><pre>
ext = <span class="hljs-built_in">window</span>.ext = <span class="hljs-keyword">new</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Extension</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">utils</span>.<span class="hljs-title">Class</span></span></pre></div></div>

        </li>


        <li id="section-208">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-208">&#182;</a>
              </div>
              <h2 id="public-constants">Public constants</h2>

            </div>

        </li>


        <li id="section-209">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-209">&#182;</a>
              </div>
              <p>String representation of the keyboard modifiers listened to by Template on Windows/Linux
platforms.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">SHORTCUT_MODIFIERS</span>: <span class="hljs-string">'Ctrl+Alt+'</span></pre></div></div>

        </li>


        <li id="section-210">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-210">&#182;</a>
              </div>
              <p>String representation of the keyboard modifiers listened to by Template on Mac platforms.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">SHORTCUT_MAC_MODIFIERS</span>: <span class="hljs-string">'&amp;#8679;&amp;#8997;'</span></pre></div></div>

        </li>


        <li id="section-211">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-211">&#182;</a>
              </div>
              <h2 id="public-variables">Public variables</h2>

            </div>

        </li>


        <li id="section-212">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-212">&#182;</a>
              </div>
              <p>Configuration data loaded at runtime.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">config</span>: {}</pre></div></div>

        </li>


        <li id="section-213">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-213">&#182;</a>
              </div>
              <p>Information specifying what should be displaying in the notification.<br>This should be reset after every copy request.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">notification</span>:
    <span class="hljs-attribute">iconUrl</span>: utils.url <span class="hljs-string">'../images/icon_64.png'</span>
    <span class="hljs-attribute">message</span>: <span class="hljs-string">''</span>
    <span class="hljs-attribute">title</span>:   <span class="hljs-string">''</span>
    <span class="hljs-attribute">type</span>:    <span class="hljs-string">'basic'</span></pre></div></div>

        </li>


        <li id="section-214">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-214">&#182;</a>
              </div>
              <p>Reference to supported URL shortener services.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">shorteners</span>: SHORTENERS</pre></div></div>

        </li>


        <li id="section-215">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-215">&#182;</a>
              </div>
              <p>Local copy of templates being used, ordered to match that specified by the user.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">templates</span>: []</pre></div></div>

        </li>


        <li id="section-216">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-216">&#182;</a>
              </div>
              <p>Pre-prepared HTML for the popup to be populated using.<br>This should be updated whenever templates are changed/updated in any way as this is generated
to improve performance and load times of the popup frame.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">templatesHtml</span>: <span class="hljs-string">''</span></pre></div></div>

        </li>


        <li id="section-217">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-217">&#182;</a>
              </div>
              <p>Current version of Template.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">version</span>: <span class="hljs-string">''</span></pre></div></div>

        </li>


        <li id="section-218">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-218">&#182;</a>
              </div>
              <h2 id="public-functions">Public functions</h2>

            </div>

        </li>


        <li id="section-219">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-219">&#182;</a>
              </div>
              <p>Add <code>str</code> to the system clipboard.<br>All successful copy requests should, at some point, call this function.<br>If <code>str</code> is empty the contents of the system clipboard will not change.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">copy</span>: <span class="hljs-function"><span class="hljs-params">(str, hidden)</span> -&gt;</span>
    log.trace()

    sandbox = $(<span class="hljs-string">'#sandbox'</span>).val(str).trigger <span class="hljs-string">'select'</span>
    <span class="hljs-built_in">document</span>.execCommand <span class="hljs-string">'copy'</span>
    log.debug <span class="hljs-string">'Copied the following string...'</span>, str
    sandbox.val <span class="hljs-string">''</span>

    <span class="hljs-keyword">do</span> showNotification <span class="hljs-keyword">unless</span> hidden</pre></div></div>

        </li>


        <li id="section-220">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-220">&#182;</a>
              </div>
              <p>Attempt to retrieve the key of the template with the specified <code>name</code>.<br>Since only the names of predefined templates are known, return a newly generated key if it does
not match any of their names.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getKeyForName</span>: <span class="hljs-function"><span class="hljs-params">(name, generate = <span class="hljs-literal">yes</span>)</span> -&gt;</span>
    log.trace()

    key = <span class="hljs-keyword">switch</span> name
      <span class="hljs-keyword">when</span> <span class="hljs-string">'_url'</span>      <span class="hljs-keyword">then</span> <span class="hljs-string">'PREDEFINED.00001'</span>
      <span class="hljs-keyword">when</span> <span class="hljs-string">'_short'</span>    <span class="hljs-keyword">then</span> <span class="hljs-string">'PREDEFINED.00002'</span>
      <span class="hljs-keyword">when</span> <span class="hljs-string">'_anchor'</span>   <span class="hljs-keyword">then</span> <span class="hljs-string">'PREDEFINED.00003'</span>
      <span class="hljs-keyword">when</span> <span class="hljs-string">'_encoded'</span>  <span class="hljs-keyword">then</span> <span class="hljs-string">'PREDEFINED.00004'</span>
      <span class="hljs-keyword">when</span> <span class="hljs-string">'_bbcode'</span>   <span class="hljs-keyword">then</span> <span class="hljs-string">'PREDEFINED.00005'</span>
      <span class="hljs-keyword">when</span> <span class="hljs-string">'_markdown'</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'PREDEFINED.00006'</span>
      <span class="hljs-keyword">else</span> utils.keyGen() <span class="hljs-keyword">if</span> generate

    log.debug <span class="hljs-string">"Associating <span class="hljs-subst">#{key}</span> key with <span class="hljs-subst">#{name}</span> template"</span>

    key</pre></div></div>

        </li>


        <li id="section-221">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-221">&#182;</a>
              </div>
              <p>Initialize the background page.<br>This will involve initializing the settings and adding the message listeners.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">init</span>: <span class="hljs-function">-&gt;</span>
    log.trace()

    log.info <span class="hljs-string">'Initializing extension controller'</span></pre></div></div>

        </li>


        <li id="section-222">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-222">&#182;</a>
              </div>
              <p>Add support for analytics if the user hasn’t opted out.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    analytics.add() <span class="hljs-keyword">if</span> store.get <span class="hljs-string">'analytics'</span></pre></div></div>

        </li>


        <li id="section-223">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-223">&#182;</a>
              </div>
              <p>Load the configuration data from the file.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    $.getJSON utils.url(<span class="hljs-string">'configuration.json'</span>), <span class="hljs-function"><span class="hljs-params">(data)</span> =&gt;</span></pre></div></div>

        </li>


        <li id="section-224">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-224">&#182;</a>
              </div>
              <p>Store the configuration data and then ensure it’s data is in the most usable format.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@config</span> = data
      <span class="hljs-keyword">do</span> buildConfig</pre></div></div>

        </li>


        <li id="section-225">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-225">&#182;</a>
              </div>
              <p>It’s nice knowing what version is running.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      {<span class="hljs-property">@version</span>} = chrome.runtime.getManifest()</pre></div></div>

        </li>


        <li id="section-226">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-226">&#182;</a>
              </div>
              <p>Initiate OAuth for each of the applicable URL shortener services.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      shortener.oauth = shortener.oauth?() <span class="hljs-keyword">for</span> shortener <span class="hljs-keyword">in</span> SHORTENERS</pre></div></div>

        </li>


        <li id="section-227">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-227">&#182;</a>
              </div>
              <p>Begin initialization.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      store.init
        <span class="hljs-attribute">links</span>:         {}
        <span class="hljs-attribute">markdown</span>:      {}
        <span class="hljs-attribute">menu</span>:          {}
        <span class="hljs-attribute">notifications</span>: {}
        <span class="hljs-attribute">shortcuts</span>:     {}
        <span class="hljs-attribute">stats</span>:         {}
        <span class="hljs-attribute">templates</span>:     []
        <span class="hljs-attribute">toolbar</span>:       {}

      <span class="hljs-keyword">do</span> init_update

      store.modify <span class="hljs-string">'links'</span>, <span class="hljs-function"><span class="hljs-params">(links)</span> -&gt;</span>
        links.target ?= <span class="hljs-literal">off</span>
        links.title  ?= <span class="hljs-literal">off</span>

      store.modify <span class="hljs-string">'markdown'</span>, <span class="hljs-function"><span class="hljs-params">(markdown)</span> -&gt;</span>
        markdown.inline ?= <span class="hljs-literal">no</span>

      store.modify <span class="hljs-string">'menu'</span>, <span class="hljs-function"><span class="hljs-params">(menu)</span> -&gt;</span>
        menu.enabled ?= <span class="hljs-literal">yes</span>
        menu.options ?= <span class="hljs-literal">yes</span>
        menu.paste   ?= <span class="hljs-literal">no</span>

      store.modify <span class="hljs-string">'notifications'</span>, <span class="hljs-function"><span class="hljs-params">(notifications)</span> -&gt;</span>
        notifications.enabled ?= <span class="hljs-literal">yes</span>

      store.modify <span class="hljs-string">'shortcuts'</span>, <span class="hljs-function"><span class="hljs-params">(shortcuts)</span> -&gt;</span>
        shortcuts.enabled ?= <span class="hljs-literal">yes</span>
        shortcuts.paste   ?= <span class="hljs-literal">no</span>

      <span class="hljs-keyword">do</span> initTemplates
      <span class="hljs-keyword">do</span> initToolbar
      <span class="hljs-keyword">do</span> initStatistics
      <span class="hljs-keyword">do</span> initUrlShorteners</pre></div></div>

        </li>


        <li id="section-228">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-228">&#182;</a>
              </div>
              <p>Add listener for toolbar/browser action clicks.<br>This listener will be ignored whenever the popup is enabled.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      chrome.browserAction.onClicked.addListener (tab) -&gt;
        onMessage
          <span class="hljs-attribute">data</span>: <span class="hljs-attribute">key</span>: store.get <span class="hljs-string">'toolbar.key'</span>
          <span class="hljs-attribute">type</span>: <span class="hljs-string">'toolbar'</span></pre></div></div>

        </li>


        <li id="section-229">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-229">&#182;</a>
              </div>
              <p>Add listeners for internal and external messages.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      chrome.extension.onMessage.addListener onMessage
      chrome.extension.onMessageExternal.addListener onMessageExternal</pre></div></div>

        </li>


        <li id="section-230">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-230">&#182;</a>
              </div>
              <p>Derive the browser and OS information.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      browser.version = <span class="hljs-keyword">do</span> getBrowserVersion
      operatingSystem = <span class="hljs-keyword">do</span> getOperatingSystem
      analytics.track <span class="hljs-string">'Installs'</span>, <span class="hljs-string">'New'</span>, <span class="hljs-property">@version</span>, Number isProductionBuild <span class="hljs-keyword">if</span> isNewInstall</pre></div></div>

        </li>


        <li id="section-231">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-231">&#182;</a>
              </div>
              <p>Execute content scripts now that we know the version.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">do</span> executeScriptsInExistingWindows</pre></div></div>

        </li>


        <li id="section-232">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-232">&#182;</a>
              </div>
              <p>Determine whether or not <code>os</code> matches the user’s operating system.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">isThisPlatform</span>: <span class="hljs-function"><span class="hljs-params">(os)</span> -&gt;</span>
    log.trace()

    <span class="hljs-regexp">/// <span class="hljs-subst">#{os}</span> ///</span>i.test navigator.platform</pre></div></div>

        </li>


        <li id="section-233">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-233">&#182;</a>
              </div>
              <p>Retrieve the correct string representation of the keyboard modifiers for the user’s operating
system.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">modifiers</span>: <span class="hljs-function">-&gt;</span>
    log.trace()

    <span class="hljs-keyword">if</span> <span class="hljs-property">@isThisPlatform</span> <span class="hljs-string">'mac'</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@SHORTCUT_MAC_MODIFIERS</span> <span class="hljs-keyword">else</span> <span class="hljs-property">@SHORTCUT_MODIFIERS</span></pre></div></div>

        </li>


        <li id="section-234">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-234">&#182;</a>
              </div>
              <p>Attempt to retrieve the contents of the system clipboard as a string.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">paste</span>: <span class="hljs-function">-&gt;</span>
    log.trace()

    result  = <span class="hljs-string">''</span>
    sandbox = $(<span class="hljs-string">'#sandbox'</span>).val(<span class="hljs-string">''</span>).trigger <span class="hljs-string">'select'</span>
    result  = sandbox.val() <span class="hljs-keyword">if</span> <span class="hljs-built_in">document</span>.execCommand <span class="hljs-string">'paste'</span>
    log.debug <span class="hljs-string">'Pasted the following string...'</span>, result
    sandbox.val <span class="hljs-string">''</span>

    result</pre></div></div>

        </li>


        <li id="section-235">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-235">&#182;</a>
              </div>
              <p>Reset the notification information associated with the current copy request.<br>This should be called when a copy request is completed regardless of its outcome.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">reset</span>: <span class="hljs-function">-&gt;</span>
    log.trace()

    <span class="hljs-property">@notification</span> =
      <span class="hljs-attribute">iconUrl</span>: utils.url <span class="hljs-string">'../images/icon_64.png'</span>
      <span class="hljs-attribute">message</span>: <span class="hljs-string">''</span>
      <span class="hljs-attribute">title</span>:   <span class="hljs-string">''</span>
      <span class="hljs-attribute">type</span>:    <span class="hljs-string">'basic'</span></pre></div></div>

        </li>


        <li id="section-236">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-236">&#182;</a>
              </div>
              <p>Update the context menu items to reflect the currently enabled templates.<br>If the context menu option has been disabled by the user, just remove all of the existing menu
items.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">updateContextMenu</span>: <span class="hljs-function">-&gt;</span>
    log.trace()</pre></div></div>

        </li>


        <li id="section-237">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-237">&#182;</a>
              </div>
              <p>Ensure that any previously added context menu items are removed.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    chrome.contextMenus.removeAll =&gt;</pre></div></div>

        </li>


        <li id="section-238">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-238">&#182;</a>
              </div>
              <p>Called whenever a template menu item is clicked.<br>Message self, passing along the available information.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function">      <span class="hljs-title">onMenuClick</span> = <span class="hljs-params">(info, tab)</span> -&gt;</span>
        onMessage <span class="hljs-attribute">data</span>: info, <span class="hljs-attribute">type</span>: <span class="hljs-string">'menu'</span>

      menu = store.get <span class="hljs-string">'menu'</span></pre></div></div>

        </li>


        <li id="section-239">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-239">&#182;</a>
              </div>
              <p>Stop now if the context menu is disabled.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> menu.enabled</pre></div></div>

        </li>


        <li id="section-240">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-240">&#182;</a>
              </div>
              <p>Create and add the top-level Template menu.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      parentId = chrome.contextMenus.create
        <span class="hljs-attribute">contexts</span>: [<span class="hljs-string">'all'</span>]
        <span class="hljs-attribute">title</span>:    i18n.get <span class="hljs-string">'name'</span></pre></div></div>

        </li>


        <li id="section-241">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-241">&#182;</a>
              </div>
              <p>Create and add a sub-menu item for each enabled template.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> template <span class="hljs-keyword">in</span> <span class="hljs-property">@templates</span> <span class="hljs-keyword">when</span> template.enabled
        notEmpty = <span class="hljs-literal">yes</span>
        menuId   = chrome.contextMenus.create
          <span class="hljs-attribute">contexts</span>: [<span class="hljs-string">'all'</span>]
          <span class="hljs-attribute">onclick</span>:  onMenuClick
          <span class="hljs-attribute">parentId</span>: parentId
          <span class="hljs-attribute">title</span>:    template.title
        template.menuId = menuId</pre></div></div>

        </li>


        <li id="section-242">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-242">&#182;</a>
              </div>
              <p>Indicate that no templates have been enabled.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">unless</span> notEmpty
        chrome.contextMenus.create
          <span class="hljs-attribute">contexts</span>: [<span class="hljs-string">'all'</span>]
          <span class="hljs-attribute">parentId</span>: parentId
          <span class="hljs-attribute">title</span>:    i18n.get <span class="hljs-string">'empty'</span></pre></div></div>

        </li>


        <li id="section-243">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-243">&#182;</a>
              </div>
              <p>Add an item to open the options page if the user doesn’t mind.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> menu.options
        chrome.contextMenus.create
          <span class="hljs-attribute">contexts</span>: [<span class="hljs-string">'all'</span>]
          <span class="hljs-attribute">parentId</span>: parentId
          <span class="hljs-attribute">type</span>:     <span class="hljs-string">'separator'</span>

        chrome.contextMenus.create
          <span class="hljs-attribute">contexts</span>: [<span class="hljs-string">'all'</span>]
          <span class="hljs-attribute">onclick</span>:  <span class="hljs-function"><span class="hljs-params">(info, tab)</span> -&gt;</span>
            onMessage <span class="hljs-attribute">type</span>: <span class="hljs-string">'options'</span>
          <span class="hljs-attribute">parentId</span>: parentId
          <span class="hljs-attribute">title</span>:    i18n.get <span class="hljs-string">'options'</span></pre></div></div>

        </li>


        <li id="section-244">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-244">&#182;</a>
              </div>
              <p>Update the local list of templates to reflect those persisted.<br>It is very important that this is called whenever templates may have been changed in order to
prepare the popup HTML and optimize performance.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">updateTemplates</span>: <span class="hljs-function">-&gt;</span>
    log.trace()

    <span class="hljs-property">@templates</span> = _.sortBy store.get(<span class="hljs-string">'templates'</span>), <span class="hljs-string">'index'</span>

    <span class="hljs-keyword">do</span> buildPopup
    <span class="hljs-keyword">do</span> <span class="hljs-property">@updateContextMenu</span>
    <span class="hljs-keyword">do</span> updateStatistics
    <span class="hljs-keyword">do</span> updateHotkeys</pre></div></div>

        </li>


        <li id="section-245">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-245">&#182;</a>
              </div>
              <p>Update the toolbar/browser action depending on the current settings.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">updateToolbar</span>: <span class="hljs-function">-&gt;</span>
    log.trace()

    key      = store.get <span class="hljs-string">'toolbar.key'</span>
    template = getTemplateWithKey key <span class="hljs-keyword">if</span> key

    <span class="hljs-keyword">do</span> buildPopup

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> template <span class="hljs-keyword">or</span> store.get <span class="hljs-string">'toolbar.popup'</span>
      log.info <span class="hljs-string">'Configuring toolbar to display popup'</span></pre></div></div>

        </li>


        <li id="section-246">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-246">&#182;</a>
              </div>
              <p>Show the popup when the browser action is clicked.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      chrome.browserAction.setPopup <span class="hljs-attribute">popup</span>: <span class="hljs-string">'pages/popup.html'</span>
    <span class="hljs-keyword">else</span>
      log.info <span class="hljs-string">'Configuring toolbar to activate specified template'</span></pre></div></div>

        </li>


        <li id="section-247">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-247">&#182;</a>
              </div>
              <p>Disable the popup, effectively enabling the listener for <code>chrome.browserAction.onClicked</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      chrome.browserAction.setPopup <span class="hljs-attribute">popup</span>: <span class="hljs-string">''</span></pre></div></div>

        </li>


        <li id="section-248">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-248">&#182;</a>
              </div>
              <h2 id="public-classes">Public classes</h2>

            </div>

        </li>


        <li id="section-249">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-249">&#182;</a>
              </div>
              <p><code>Icon</code> provides common functionality for using icons throughout the extension.</p>

            </div>

            <div class="content"><div class='highlight'><pre>ext.Icon = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Icon</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">utils</span>.<span class="hljs-title">Class</span></span></pre></div></div>

        </li>


        <li id="section-250">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-250">&#182;</a>
              </div>
              <p>Create a new instance of <code>Icon</code> with the specified <code>name</code>.<br>An appropriate localized message and CSS style is also derived.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@name</span>)</span> -&gt;</span>
    <span class="hljs-property">@message</span> = i18n.get <span class="hljs-string">"icon_<span class="hljs-subst">#{name?.replace(<span class="hljs-regexp">/-/g</span>, <span class="hljs-string">'_'</span>) <span class="hljs-keyword">or</span> <span class="hljs-string">'none'</span>}</span>"</span>
    <span class="hljs-property">@style</span>   = <span class="hljs-string">"icon-<span class="hljs-subst">#{name <span class="hljs-keyword">or</span> <span class="hljs-string">''</span>}</span>"</span></pre></div></div>

        </li>


        <li id="section-251">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-251">&#182;</a>
              </div>
              <p>Determine whether an <code>Icon</code> with the given <code>name</code> exists.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Icon.exists = <span class="hljs-function"><span class="hljs-params">(name)</span> -&gt;</span>
  Icon.get(name)?</pre></div></div>

        </li>


        <li id="section-252">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-252">&#182;</a>
              </div>
              <p>Retrieve the <code>Icon</code> with the given <code>name</code>.<br><code>safe</code> can be used to ensure that an <code>Icon</code> is always returned, although this will be <em>empty</em> (no
name) if none had a matching <code>name</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Icon.get = <span class="hljs-function"><span class="hljs-params">(name, safe)</span> -&gt;</span>
  icon = _.findWhere ext.config.icons.current, {name}

  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> icon? <span class="hljs-keyword">and</span> safe <span class="hljs-keyword">then</span> <span class="hljs-keyword">new</span> Icon() <span class="hljs-keyword">else</span> icon</pre></div></div>

        </li>


        <li id="section-253">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-253">&#182;</a>
              </div>
              <p>Attempt to retrieve the replacement for the legacy icon with the given <code>name</code>.<br>If <code>name</code> is a number it will be treated as an index of the legacy icon; otherwise a simple
lookup is performed.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Icon.fromLegacy = <span class="hljs-function"><span class="hljs-params">(name)</span> -&gt;</span>
  legacy = <span class="hljs-keyword">switch</span> <span class="hljs-keyword">typeof</span> name
    <span class="hljs-keyword">when</span> <span class="hljs-string">'number'</span> <span class="hljs-keyword">then</span> ext.config.icons.legacy[name]
    <span class="hljs-keyword">when</span> <span class="hljs-string">'string'</span> <span class="hljs-keyword">then</span> _.findWhere ext.config.icons.legacy, {name}

  <span class="hljs-keyword">if</span> legacy <span class="hljs-keyword">then</span> Icon.get legacy.icon</pre></div></div>

        </li>


        <li id="section-254">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-254">&#182;</a>
              </div>
              <p>Initialize <code>ext</code> when the DOM is ready.</p>

            </div>

            <div class="content"><div class='highlight'><pre>utils.ready -&gt; ext.init()</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
